<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电力市场综合热力图</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. React 全家桶 (Staticfile CDN) -->
    <script crossorigin src="https://cdn.staticfile.net/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.net/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Staticfile CDN) -->
    <script src="https://cdn.staticfile.net/babel-standalone/7.22.20/babel.min.js"></script>

    <!-- 4. ECharts (Staticfile CDN) -->
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
            const { useState, useEffect, useRef, useMemo } = React;

        // --- 图标组件 ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const X = (props) => (<IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>);
        const Activity = (props) => (<IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>);
        const TrendingUp = (props) => (<IconWrapper {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconWrapper>);
        const BarChart3 = (props) => (<IconWrapper {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconWrapper>);
        const Coins = (props) => (<IconWrapper {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconWrapper>);
        const Zap = (props) => (<IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>);
        const ArrowLeft = (props) => (<IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>);
        const MapIcon = (props) => (<IconWrapper {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconWrapper>);
        const ChevronLeft = (props) => (<IconWrapper {...props}><path d="m15 18-6-6 6-6"/></IconWrapper>);
        const ChevronRight = (props) => (<IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>);
        const ArchiveIcon = (props) => (
            <IconWrapper {...props}>
                <rect x="3" y="4" width="18" height="4" rx="1" />
                <path d="M6 8v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8" />
                <path d="M10 12h4" />
            </IconWrapper>
        );
        const Layers = (props) => (<IconWrapper {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconWrapper>);
        const BatteryCharging = (props) => (<IconWrapper {...props}><path d="M5 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3.19M15 6h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3.19"/><line x1="23" x2="23" y1="13" y2="11"/><polyline points="11 6 7 12 13 12 9 18"/></IconWrapper>);

        const GANSU_PROVINCE_DEFAULT = {
            provinceCode: 'GS',
            name: '甘肃',
            title: '甘肃',
            kpis: [
                { label: '调频总额', value: '2500-2600 万元/月' },
                { label: '现货价差(均值)', value: '0.253 元/kWh' },
                { label: '调频上限', value: '15 元/MW' },
                { label: '容量电价', value: '330 元/kW·年（执行2年）' }
            ],
            accordions: [
                {
                    key: 'A',
                    title: '资源禀赋 & 电网背景',
                    type: 'list',
                    items: [
                        '区位：位于西北电网中心，是西电东送的重要通道、西北电力交换枢纽',
                        '结构错配：新能源基地（河西走廊）与负荷中心（河东兰州等地）错配，网架阻塞突出，形成对调频等辅助服务的刚性需求',
                        '新能源资源：风能可开发量 5.6 亿 kW；太阳能可开发量 95 亿 kW（资源理论储量全国第4）',
                        '规划：到 2025 年新能源装机 8000 万 kW；2030 年突破 1.6 亿 kW',
                        '装机概况：截至 2025 年 9 月，全口径装机容量 11612.75 万 kW；风光装机占比约 61%',
                        '新能源分布：河西走廊地区（张掖、武威、金昌）优势明显；日照时间长、强度高、戈壁大漠适合大型基地；风力强劲且稳定',
                        '负荷与调峰：2024 年全社会用电量 1746.33 亿 kWh；最大用电负荷 2395 万 kW；峰谷差 400–500 万 kW；最大调峰缺口超 1000 万 kW'
                    ],
                    capacityData: {
                        title: '装机容量结构（万千瓦）',
                        headers: ['电源类型', '装机容量', '占比'],
                        rows: [
                            { type: '火电', capacity: '3150.21', share: '27.13%' },
                            { type: '水电', capacity: '971.61', share: '8.37%' },
                            { type: '风电', capacity: '3780.80', share: '32.56%' },
                            { type: '太阳能', capacity: '3710.13', share: '31.95%' },
                            { type: '储能', capacity: '659.48', share: '-' }
                        ],
                        pie: [
                            { name: '火电', value: 3150.21 },
                            { name: '水电', value: 971.61 },
                            { name: '风电', value: 3780.8 },
                            { name: '太阳能', value: 3710.13 },
                            { name: '储能', value: 659.48 }
                        ],
                        note: '数据来源：甘肃电力交易中心披露的装机容量结构'
                    }
                },
                {
                    key: 'B',
                    title: '现货市场进程',
                    type: 'list',
                    items: [
                        '2021年5月：开展连续不间断结算试运行，形成现货交易规则雏形',
                        '2024年9月5日：转入正式运行，标志着现货市场常态化落地'
                    ]
                },
                {
                    key: 'C',
                    title: '现货电价（1-7月统计）',
                    type: 'keyValue',
                    items: [
                        { label: '平均最低电价', value: '0.099 元/kWh' },
                        { label: '平均最高电价', value: '0.352 元/kWh' },
                        { label: '其他费用（系统运行费及线损）', value: '0.03 元/kWh' },
                        { label: '平均电价差', value: '0.253 元/kWh' },
                        { label: '河西走廊平均电价差', value: '0.27 元/kWh' }
                    ]
                },
                {
                    key: 'D',
                    title: '调频（辅助服务）',
                    type: 'sections',
                    sections: [
                        {
                            heading: '规则',
                            items: ['报价上限：15 元/MW', '最小申报单位：0.1 元/MW']
                        },
                        {
                            heading: '收益公式',
                            items: ['调频收益 = 调频里程 × K（上限2）× 中标价格（上限15元/MW）']
                        },
                        {
                            heading: '示例项目（100MW/400MWh）',
                            items: [
                                '年调频里程：432000 MW',
                                'K：1.85',
                                '中标价格：15 元/MW',
                                '调频收益：1199 万元/年'
                            ]
                        }
                    ]
                },
                {
                    key: 'E',
                    title: '容量电价',
                    type: 'keyValue',
                    items: [
                        { label: '标准', value: '330 元/kW·年' },
                        { label: '执行期限', value: '2 年' },
                        { label: '厂用电（用于有效容量计算）', value: '5%' },
                        { label: '有效容量（示例）', value: '63.33 MW' },
                        { label: '容量电价收益（示例）', value: '2090 万元/年' },
                        { label: '两年后预测电价', value: '200 元/kW·年' },
                        { label: '两年后预测收益', value: '1267 万元/年' }
                    ]
                },
                {
                    key: 'F',
                    title: '收益 & 财务（100MW/400MWh）',
                    type: 'finance',
                    table: {
                        headers: ['首年(万元)', '每年(万元)', '20年(万元)'],
                        rows: [
                            { label: '电能量交易', values: ['2495', '2196', '43920'] },
                            { label: '调频', values: ['1199', '1075', '21500'] },
                            { label: '容量电价', values: ['2090', '1350', '27000'] },
                            { label: '总收益', values: ['5784', '4621', '92420'] }
                        ]
                    },
                    metrics: [
                        { label: 'IRR', value: '9.279%' },
                        { label: '回收期', value: '7.095 年' }
                    ]
                }
            ],
            footerNote: '数据来源：《甘肃省独立储能政策分析.pdf》'
        };

        const GansuProvinceSidebarText = ({ mode = 'VIEW', onClose, gridList = [], onUploadGrid }) => {
            const isEdit = mode === 'EDIT';
            const baseData = useMemo(() => JSON.parse(JSON.stringify(GANSU_PROVINCE_DEFAULT)), []);
            const buildAccordionState = (accordions = []) => {
                return (accordions || []).reduce((acc, item) => ({ ...acc, [item.key]: false }), {});
            };

            const [data, setData] = useState(baseData);
            const [jsonValue, setJsonValue] = useState(JSON.stringify(baseData, null, 2));
            const [jsonError, setJsonError] = useState('');
            const [openStates, setOpenStates] = useState(() => buildAccordionState(baseData?.accordions));
            const capacityPieRef = useRef(null);
            const capacityPieInstanceRef = useRef(null);
            const latestGridItem = useMemo(() => {
                const validList = Array.isArray(gridList) ? gridList.filter(Boolean) : [];
                const userUploads = validList.filter((item) => item?.id !== 'gansu-grid-default');
                if (userUploads.length) return userUploads[userUploads.length - 1];
                return validList[validList.length - 1] || null;
            }, [gridList]);

            const handleGansuGridUpload = (event) => {
                const files = Array.from(event.target.files || []);
                if (!files.length || !onUploadGrid) return;
                onUploadGrid(files);
                event.target.value = '';
            };

            useEffect(() => {
                setData(baseData);
                setJsonValue(JSON.stringify(baseData, null, 2));
                setOpenStates(buildAccordionState(baseData?.accordions));
            }, [baseData]);

            useEffect(() => {
                setJsonValue(JSON.stringify(data, null, 2));
            }, [data]);

            useEffect(() => {
                const capacityAccordion = (data.accordions || []).find((accordion) => accordion.capacityData);
                if (!capacityAccordion || !capacityPieRef.current) return;

                const isAccordionOpen = openStates?.[capacityAccordion.key];
                if (!isAccordionOpen) {
                    if (capacityPieInstanceRef.current) {
                        capacityPieInstanceRef.current.dispose();
                        capacityPieInstanceRef.current = null;
                    }
                    return;
                }

                const pieData = (capacityAccordion.capacityData?.pie || []).map((item) => ({
                    name: item.name,
                    value: Number(item.value) || 0
                }));

                if (!capacityPieInstanceRef.current) {
                    capacityPieInstanceRef.current = echarts.init(capacityPieRef.current);
                }

                capacityPieInstanceRef.current.setOption({
                    tooltip: { trigger: 'item', formatter: '{b}: {c}（{d}%）' },
                    legend: { show: true, top: 0, textStyle: { color: '#334155', fontSize: 12 } },
                    series: [
                        {
                            name: '装机结构',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
                            label: { formatter: '{b}: {d}%', color: '#0f172a' },
                            data: pieData
                        }
                    ]
                });

                capacityPieInstanceRef.current.resize();

                return () => {
                    if (capacityPieInstanceRef.current) {
                        capacityPieInstanceRef.current.dispose();
                        capacityPieInstanceRef.current = null;
                    }
                };
            }, [data, openStates]);

            const toggleAccordion = (key) => {
                setOpenStates((prev) => ({ ...prev, [key]: !prev?.[key] }));
            };

            const updateTitle = (value) => setData((prev) => ({ ...prev, title: value }));
            const updateKpi = (index, field, value) => {
                setData((prev) => {
                    const nextKpis = [...(prev.kpis || [])];
                    nextKpis[index] = { ...(nextKpis[index] || {}), [field]: value };
                    return { ...prev, kpis: nextKpis };
                });
            };

            const updateListItem = (accordionKey, itemIndex, value) => {
                setData((prev) => {
                    const nextAccordions = [...(prev.accordions || [])];
                    const target = nextAccordions.find((a) => a.key === accordionKey);
                    if (target) {
                        const nextItems = [...(target.items || [])];
                        nextItems[itemIndex] = value;
                        target.items = nextItems;
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const updateKeyValueItem = (accordionKey, itemIndex, field, value) => {
                setData((prev) => {
                    const nextAccordions = [...(prev.accordions || [])];
                    const target = nextAccordions.find((a) => a.key === accordionKey);
                    if (target) {
                        const nextItems = [...(target.items || [])];
                        nextItems[itemIndex] = { ...(nextItems[itemIndex] || {}), [field]: value };
                        target.items = nextItems;
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const updateSectionItem = (accordionKey, sectionIndex, itemIndex, value) => {
                setData((prev) => {
                    const nextAccordions = [...(prev.accordions || [])];
                    const target = nextAccordions.find((a) => a.key === accordionKey);
                    if (target) {
                        const nextSections = [...(target.sections || [])];
                        const section = nextSections[sectionIndex];
                        if (section) {
                            const nextItems = [...(section.items || [])];
                            nextItems[itemIndex] = value;
                            section.items = nextItems;
                        }
                        target.sections = nextSections;
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const updateSectionHeading = (accordionKey, sectionIndex, value) => {
                setData((prev) => {
                    const nextAccordions = [...(prev.accordions || [])];
                    const target = nextAccordions.find((a) => a.key === accordionKey);
                    if (target) {
                        const nextSections = [...(target.sections || [])];
                        if (nextSections[sectionIndex]) {
                            nextSections[sectionIndex] = { ...(nextSections[sectionIndex] || {}), heading: value };
                        }
                        target.sections = nextSections;
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const updateFinanceTable = (rowIndex, colIndex, value) => {
                setData((prev) => {
                    const table = prev.accordions?.find((a) => a.type === 'finance')?.table;
                    const nextAccordions = [...(prev.accordions || [])];
                    const financeAccordion = nextAccordions.find((a) => a.type === 'finance');
                    if (financeAccordion && table) {
                        const nextTable = { ...table, rows: [...(table.rows || [])] };
                        const targetRow = { ...(nextTable.rows[rowIndex] || {}) };
                        const nextValues = [...(targetRow.values || [])];
                        nextValues[colIndex] = value;
                        targetRow.values = nextValues;
                        nextTable.rows[rowIndex] = targetRow;
                        financeAccordion.table = nextTable;
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const updateFinanceLabel = (rowIndex, value) => {
                setData((prev) => {
                    const nextAccordions = [...(prev.accordions || [])];
                    const financeAccordion = nextAccordions.find((a) => a.type === 'finance');
                    if (financeAccordion?.table?.rows?.[rowIndex]) {
                        const nextRows = [...financeAccordion.table.rows];
                        nextRows[rowIndex] = { ...(nextRows[rowIndex] || {}), label: value };
                        financeAccordion.table = { ...(financeAccordion.table || {}), rows: nextRows };
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const updateFinanceMetric = (metricIndex, value) => {
                setData((prev) => {
                    const nextAccordions = [...(prev.accordions || [])];
                    const financeAccordion = nextAccordions.find((a) => a.type === 'finance');
                    if (financeAccordion?.metrics?.[metricIndex]) {
                        const nextMetrics = [...financeAccordion.metrics];
                        nextMetrics[metricIndex] = { ...(nextMetrics[metricIndex] || {}), value };
                        financeAccordion.metrics = nextMetrics;
                    }
                    return { ...prev, accordions: nextAccordions };
                });
            };

            const handleJsonApply = () => {
                try {
                    const parsed = JSON.parse(jsonValue);
                    setData(parsed);
                    setOpenStates(buildAccordionState(parsed?.accordions));
                    setJsonError('');
                } catch (err) {
                    setJsonError('JSON 解析失败，请检查格式是否正确');
                }
            };

            if (!data?.accordions) {
                return <div className="p-6 text-sm text-slate-500">正在加载甘肃省侧栏数据...</div>;
            }

            return (
                <div className="flex flex-col h-full bg-white">
                    <div className="sticky top-0 z-10 bg-white border-b border-slate-200 p-6">
                        <div className="flex items-start justify-between">
                            <div className="space-y-2">
                                {isEdit ? (
                                    <input
                                        value={data.title || ''}
                                        onChange={(e) => updateTitle(e.target.value)}
                                        className="text-2xl font-bold text-slate-900 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                                    />
                                ) : (
                                    <h2 className="text-2xl font-bold text-slate-900">{data.title || '甘肃'}</h2>
                                )}
                               
                            </div>
                            <div className="flex items-center gap-2">
                                <span className={`px-3 py-1 rounded-full text-[11px] font-bold border ${isEdit ? 'bg-amber-50 text-amber-700 border-amber-200' : 'bg-emerald-50 text-emerald-700 border-emerald-200'}`}>
                                    {mode}
                                </span>
                                {onClose && (
                                    <button
                                        onClick={onClose}
                                        className="p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"
                                    >
                                        <X size={18} />
                                    </button>
                                )}
                            </div>
                        </div>

                        <div className="mt-4 flex flex-col gap-2">
                            {(data.kpis || []).map((item, idx) => (
                                <div
                                    key={idx}
                                    className="flex items-center justify-between border border-slate-200 rounded-lg px-3 py-2 bg-slate-50"
                                >
                                    {isEdit ? (
                                        <div className="flex-1 flex flex-col gap-1 text-sm text-slate-600">
                                            <input
                                                value={item.label || ''}
                                                onChange={(e) => updateKpi(idx, 'label', e.target.value)}
                                                className="border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                            <input
                                                value={item.value || ''}
                                                onChange={(e) => updateKpi(idx, 'value', e.target.value)}
                                                className="border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                        </div>
                                    ) : (
                                        <>
                                            <div className="text-sm text-slate-500 font-medium">{item.label}</div>
                                            <div className="text-base font-bold text-slate-900">{item.value}</div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="mt-3 border border-blue-100 rounded-lg p-3 bg-blue-50/40 space-y-2">
                            <div className="flex items-center justify-between gap-2">
                                <div className="flex items-center gap-2 text-xs font-bold text-blue-700 uppercase tracking-wider">
                                    <Layers size={14} />
                                    网架/规划示意图
                                </div>
                                {isEdit && (
                                    <label className="text-[11px] font-semibold text-blue-700 border border-blue-200 bg-white px-2 py-1 rounded cursor-pointer hover:bg-blue-50">
                                        上传
                                        <input type="file" accept="image/*" multiple onChange={handleGansuGridUpload} className="hidden" />
                                    </label>
                                )}
                            </div>
                            {latestGridItem ? (
                                <div className="rounded-lg overflow-hidden border border-blue-100 bg-white shadow-sm">
                                    <img src={latestGridItem.src} alt={latestGridItem.name || '甘肃网架示意图'} className="w-full h-28 object-cover" />
                                    <div className="text-[11px] text-slate-500 px-3 py-1.5 flex items-center justify-between">
                                        <span className="truncate" title={latestGridItem.name || '甘肃网架示意图'}>{latestGridItem.name || '甘肃网架示意图'}</span>
                                        {latestGridItem.updatedAt && (
                                            <span className="text-[10px] text-slate-400">
                                                更新: {latestGridItem.updatedAt === '内置示意' ? latestGridItem.updatedAt : new Date(latestGridItem.updatedAt).toLocaleDateString('zh-CN')}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <div className="text-[12px] text-slate-600 border border-dashed border-blue-200 rounded-md px-3 py-2 bg-white/70">
                                    尚未上传网架图，支持在此直接为甘肃侧栏添加。
                                </div>
                            )}
                            <div className="text-[11px] text-slate-500">上传内容仅关联甘肃省，会在侧栏与地图详情里同步展示。</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                        {(data.accordions || []).map((accordion) => (
                            <div key={accordion.key} className="border border-slate-200 rounded-xl shadow-sm">
                                <button
                                    className="w-full flex items-center justify-between px-4 py-3 bg-slate-50 hover:bg-slate-100 transition-colors"
                                    onClick={() => toggleAccordion(accordion.key)}
                                >
                                    <span className="text-sm font-bold text-slate-800">{accordion.title}</span>
                                    <span className="text-slate-400">{openStates[accordion.key] ? <ChevronLeft size={16} /> : <ChevronRight size={16} />}</span>
                                </button>
                                {openStates[accordion.key] && (
                                    <div className="px-4 py-4 space-y-3">
                                        {accordion.type === 'list' && (
                                            <div className="space-y-4">
                                                <div className="space-y-2">
                                                    {(accordion.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex items-start gap-2 text-sm text-slate-700">
                                                            <span className="text-slate-300">•</span>
                                                            {isEdit ? (
                                                                <textarea
                                                                    value={item || ''}
                                                                    onChange={(e) => updateListItem(accordion.key, idx, e.target.value)}
                                                                    className="w-full border border-slate-200 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                />
                                                            ) : (
                                                                <span className="leading-relaxed">{item}</span>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>

                                                {accordion.capacityData && (
                                                    <div className="space-y-3">
                                                        <div className="flex flex-wrap items-center justify-between gap-2">
                                                            <div className="text-sm font-semibold text-slate-800">{accordion.capacityData.title}</div>
                                                            {accordion.capacityData.note && (
                                                                <div className="text-xs text-slate-500">{accordion.capacityData.note}</div>
                                                            )}
                                                        </div>
                                                        <div className="space-y-4">
                                                            <div className="border border-slate-200 rounded-lg overflow-hidden bg-white">
                                                                <div className="grid grid-cols-3 bg-slate-50 text-xs font-semibold text-slate-600">
                                                                    {(accordion.capacityData.headers || []).map((header, idx) => (
                                                                        <div key={idx} className="px-3 py-2 border-r border-slate-200 last:border-r-0">
                                                                            {header}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                                <div className="divide-y divide-slate-200 text-sm">
                                                                    {(accordion.capacityData.rows || []).map((row, idx) => (
                                                                        <div key={idx} className="grid grid-cols-3">
                                                                            <div className="px-3 py-2 border-r border-slate-100 text-slate-800 font-medium">{row.type}</div>
                                                                            <div className="px-3 py-2 border-r border-slate-100 text-slate-700">{row.capacity}</div>
                                                                            <div className="px-3 py-2 text-slate-700">{row.share}</div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                            <div className="h-64 w-full" ref={capacityPieRef}></div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {accordion.type === 'keyValue' && (
                                            <div className="space-y-2">
                                                {(accordion.items || []).map((item, idx) => (
                                                    <div key={idx} className="flex flex-col gap-1 text-sm text-slate-700">
                                                        {isEdit ? (
                                                            <>
                                                                <input
                                                                    value={item.label || ''}
                                                                    onChange={(e) => updateKeyValueItem(accordion.key, idx, 'label', e.target.value)}
                                                                    className="border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                />
                                                                <input
                                                                    value={item.value || ''}
                                                                    onChange={(e) => updateKeyValueItem(accordion.key, idx, 'value', e.target.value)}
                                                                    className="border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                />
                                                            </>
                                                        ) : (
                                                            <div className="flex items-center justify-between gap-3">
                                                                <span className="text-slate-600">{item.label}</span>
                                                                <span className="font-semibold text-slate-900">{item.value}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {accordion.type === 'sections' && (
                                            <div className="space-y-4">
                                                {(accordion.sections || []).map((section, sIdx) => (
                                                    <div key={sIdx} className="space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-1 h-4 bg-blue-500 rounded-full"></div>
                                                            {isEdit ? (
                                                                <input
                                                                    value={section.heading || ''}
                                                                    onChange={(e) => updateSectionHeading(accordion.key, sIdx, e.target.value)}
                                                                    className="border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full"
                                                                />
                                                            ) : (
                                                                <span className="text-sm font-semibold text-slate-800">{section.heading}</span>
                                                            )}
                                                        </div>
                                                        <div className="space-y-2 pl-3">
                                                            {(section.items || []).map((item, idx) => (
                                                                <div key={idx} className="flex items-start gap-2 text-sm text-slate-700">
                                                                    <span className="text-slate-300">•</span>
                                                                    {isEdit ? (
                                                                        <textarea
                                                                            value={item || ''}
                                                                            onChange={(e) => updateSectionItem(accordion.key, sIdx, idx, e.target.value)}
                                                                            className="w-full border border-slate-200 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                        />
                                                                    ) : (
                                                                        <span className="leading-relaxed">{item}</span>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {accordion.type === 'finance' && (
                                            <div className="space-y-4">
                                                <div className="border border-slate-200 rounded-lg overflow-hidden">
                                                    <div className="grid grid-cols-4 bg-slate-50 text-xs font-semibold text-slate-600">
                                                        <div className="px-3 py-2 border-r border-slate-200">收益结构表格</div>
                                                        {(accordion.table?.headers || []).map((header, idx) => (
                                                            <div key={idx} className={`px-3 py-2 border-r border-slate-200 last:border-r-0 ${idx === (accordion.table.headers.length - 1) ? 'border-r-0' : ''}`}>
                                                                {header}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="divide-y divide-slate-200 bg-white text-sm">
                                                        {(accordion.table?.rows || []).map((row, rIdx) => (
                                                            <div key={rIdx} className="grid grid-cols-4">
                                                                <div className="px-3 py-2 border-r border-slate-100 flex items-center">
                                                                    {isEdit ? (
                                                                        <input
                                                                            value={row.label || ''}
                                                                            onChange={(e) => updateFinanceLabel(rIdx, e.target.value)}
                                                                            className="w-full border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                        />
                                                                    ) : (
                                                                        <span className="font-medium text-slate-800">{row.label}</span>
                                                                    )}
                                                                </div>
                                                                {(row.values || []).map((val, cIdx) => (
                                                                    <div key={cIdx} className="px-3 py-2 border-r border-slate-100 flex items-center last:border-r-0">
                                                                        {isEdit ? (
                                                                            <input
                                                                                value={val || ''}
                                                                                onChange={(e) => updateFinanceTable(rIdx, cIdx, e.target.value)}
                                                                                className="w-full border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                            />
                                                                        ) : (
                                                                            <span className="text-slate-800">{val}</span>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="space-y-1 text-sm text-slate-700">
                                                    {(accordion.metrics || []).map((metric, idx) => (
                                                        <div key={idx} className="flex items-center gap-2">
                                                            <span className="text-slate-500 w-16">{metric.label}：</span>
                                                            {isEdit ? (
                                                                <input
                                                                    value={metric.value || ''}
                                                                    onChange={(e) => updateFinanceMetric(idx, e.target.value)}
                                                                    className="flex-1 border border-slate-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                />
                                                            ) : (
                                                                <span className="font-semibold text-slate-900">{metric.value}</span>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}

                        {isEdit && (
                            <div className="space-y-2 border border-slate-200 rounded-xl p-4 bg-slate-50">
                                <div className="text-sm font-semibold text-slate-800">JSON 编辑器（即时渲染）</div>
                                <textarea
                                    value={jsonValue}
                                    onChange={(e) => setJsonValue(e.target.value)}
                                    rows={10}
                                    className="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="在此粘贴或修改 JSON，以一次性更新全部侧栏数据"
                                />
                                {jsonError && <div className="text-xs text-red-600">{jsonError}</div>}
                                <button
                                    onClick={handleJsonApply}
                                    className="w-full bg-slate-900 text-white py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition-colors"
                                >
                                    应用 JSON 数据
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="border-t border-slate-200 px-6 py-3 text-xs text-slate-500 bg-white">
                        {data.footerNote || '数据来源：暂无'}
                    </div>
                </div>
            );
        };

        const EnergyMarketMap = () => {
            const mapContainerRef = useRef(null);
            const chartInstanceRef = useRef(null);
            const pieContainerRef = useRef(null);
            const pieInstanceRef = useRef(null);
            
            // --- 核心状态 ---
            const [marketType, setMarketType] = useState('frequency'); // 'overview' | 'frequency' | 'energy' | 'resource'
            const [energyView, setEnergyView] = useState('price'); // 'price' | 'spot-progress'
            const [viewMode, setViewMode] = useState('china'); // 'china' | 'province'
            const [currentProvince, setCurrentProvince] = useState(null);
            const [selectedProvinceInfo, setSelectedProvinceInfo] = useState(null);
            const [selectedProvinceName, setSelectedProvinceName] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [sidebarWidth, setSidebarWidth] = useState(288);
            const [isResizingSidebar, setIsResizingSidebar] = useState(false);
            const [interactionMode, setInteractionMode] = useState('view'); // 'view' | 'edit'
            const [gridUploads, setGridUploads] = useState({});
            const [gridUploadProvince, setGridUploadProvince] = useState('');
            const [showArchivePanel, setShowArchivePanel] = useState(false);
            const [previewImage, setPreviewImage] = useState(null);
            const sidebarResizeDataRef = useRef({ startX: 0, startWidth: 288 });

            // --- 省份 Adcode 映射 ---
            const adcodeMap = {
                '河北省': 130000, '山西省': 140000, '广东省': 440000,
                '甘肃省': 620000, '河南省': 410000, '宁夏回族自治区': 640000,
                '江苏省': 320000, '浙江省': 330000, '陕西省': 610000,
                '北京市': 110000, '天津市': 120000, '山东省': 370000,
                '安徽省': 340000, '福建省': 350000, '上海市': 310000,
                '湖北省': 420000, '湖南省': 430000, '江西省': 360000,
                '吉林省': 220000, '黑龙江省': 230000, '辽宁省': 210000,
                '内蒙古自治区': 150000, '青海省': 630000, '新疆维吾尔自治区': 650000,
                '四川省': 510000, '重庆市': 500000, '广西壮族自治区': 450000,
                '贵州省': 520000, '云南省': 530000, '海南省': 460000
            };

            // --- 配置定义 ---
            
            const brandBlueScale = ['#E5F4FF', '#BFE2FF', '#8CC7FF', '#53A8FF', '#2B86F6', '#1B64D8', '#0E46A5'];
            const hoverHighlightColor = '#facc15';

            // 1. 颜色配置 (根据市场类型切换)
            const colorPalettes = {
                overview: {
                    map: ['#f4f4f5', '#0ea5e9', '#34d399'],
                    highlight: hoverHighlightColor,
                    iconBg: 'bg-slate-50', iconText: 'text-slate-700', iconBorder: 'border-slate-100',
                    gradientFrom: 'from-slate-800', gradientTo: 'to-blue-400'
                },
                frequency: {
                    // 品牌蓝色系 (代表热度/收益)
                    map: [brandBlueScale[6], brandBlueScale[5], brandBlueScale[4], brandBlueScale[3], brandBlueScale[2]],
                    highlight: hoverHighlightColor,
                    iconBg: 'bg-blue-50', iconText: 'text-blue-700', iconBorder: 'border-blue-100',
                    gradientFrom: 'from-[#001A72]', gradientTo: 'to-[#66D4FF]'
                },
                energy: {
                    // 与其他视图保持统一的蓝色系
                    map: [brandBlueScale[2], brandBlueScale[3], brandBlueScale[4], brandBlueScale[5], brandBlueScale[6]],
                    highlight: hoverHighlightColor,
                    iconBg: 'bg-blue-50', iconText: 'text-blue-700', iconBorder: 'border-blue-100',
                    gradientFrom: 'from-[#001A72]', gradientTo: 'to-[#66D4FF]'
                },
                resource: {
                    map: ['#ecfdf3', '#d1fae5', '#a7f3d0', '#6ee7b7', '#34d399', '#10b981', '#047857'],
                    highlight: '#f59e0b',
                    iconBg: 'bg-green-50', iconText: 'text-emerald-700', iconBorder: 'border-green-100',
                    gradientFrom: 'from-emerald-700', gradientTo: 'to-lime-300'
                }
            };

            const currentPalette = colorPalettes[marketType];

            // 2. 点位类型配置
            const pointTypeConfig = {
                'N': { color: '#22c55e', symbol: 'circle', label: '新能源 (风/光)', beltColor: '#86efac' },
                'F': { color: '#7e22ce', symbol: 'rect', label: '火电/煤电', beltColor: '#d8b4fe' },
                'S': { color: '#0ea5e9', symbol: 'triangle', label: '调节/水电/核电', beltColor: '#7dd3fc' },
                // 电能量市场可能用到的新类型 (预留)
                'L': { color: '#0057F1', symbol: 'diamond', label: '负荷中心', beltColor: '#A8ECFF' }
            };

            const gansuGridIllustration = `data:image/svg+xml;utf8,${encodeURIComponent(`
                <svg width="960" height="460" viewBox="0 0 960 460" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                            <path d="M 0 0 L 10 5 L 0 10 z" fill="#374151" />
                        </marker>
                    </defs>
                    <rect x="0" y="0" width="960" height="460" rx="18" fill="#f8fafc" />
                    <circle cx="220" cy="200" r="80" fill="#dcfce7" stroke="#16a34a" stroke-width="2" />
                    <text x="220" y="185" text-anchor="middle" font-size="16" fill="#15803d" font-weight="700">新能源消纳</text>
                    <text x="220" y="210" text-anchor="middle" font-size="14" fill="#15803d" font-weight="600">基地集群</text>
                    <circle cx="660" cy="250" r="88" fill="#e0f2fe" stroke="#0284c7" stroke-width="2" />
                    <text x="660" y="235" text-anchor="middle" font-size="16" fill="#075985" font-weight="700">负荷中心</text>
                    <text x="660" y="260" text-anchor="middle" font-size="14" fill="#075985" font-weight="600">兰州—天水—庆阳</text>

                    <line x1="220" y1="200" x2="660" y2="250" stroke="#334155" stroke-width="3" stroke-dasharray="8 6" marker-end="url(#arrow)" />
                    <line x1="220" y1="200" x2="540" y2="120" stroke="#16a34a" stroke-width="3" marker-end="url(#arrow)" />
                    <line x1="220" y1="200" x2="460" y2="330" stroke="#16a34a" stroke-width="3" marker-end="url(#arrow)" />
                    <line x1="540" y1="120" x2="760" y2="120" stroke="#7e22ce" stroke-width="3" marker-end="url(#arrow)" />
                    <line x1="540" y1="120" x2="520" y2="40" stroke="#7e22ce" stroke-width="3" marker-end="url(#arrow)" />
                    <line x1="460" y1="330" x2="780" y2="330" stroke="#0ea5e9" stroke-width="3" marker-end="url(#arrow)" />
                    <line x1="460" y1="330" x2="420" y2="410" stroke="#0ea5e9" stroke-width="3" marker-end="url(#arrow)" />

                    <text x="540" y="105" font-size="12" fill="#6b7280">宁夏电网</text>
                    <text x="525" y="55" font-size="12" fill="#6b7280">新甘电网</text>
                    <text x="780" y="115" font-size="12" fill="#6b7280">陕西电网</text>
                    <text x="780" y="345" font-size="12" fill="#6b7280">青海电网</text>
                    <text x="410" y="430" font-size="12" fill="#6b7280">陇东—陕北联络</text>
                    <text x="200" y="340" font-size="12" fill="#6b7280">酒泉—瓜州—玉门</text>
                    <text x="160" y="360" font-size="12" fill="#6b7280">新能源走廊</text>
                    <text x="630" y="295" font-size="12" fill="#6b7280">河东负荷中心</text>
                </svg>
            `)} `;

            // --- 数据源 ---

            // A0. 资源禀赋数据（可扩展、可上传）
            const [resourceEndowment, setResourceEndowment] = useState({
                '河北省': { wind: 32, solar: 26, hydro: 3, thermal: 45 },
                '山西省': { wind: 28, solar: 22, hydro: 2, thermal: 58 },
                '广东省': { wind: 18, solar: 30, hydro: 16, thermal: 38 },
                '甘肃省': { wind: 40, solar: 35, hydro: 6, thermal: 20 },
                '河南省': { wind: 20, solar: 24, hydro: 5, thermal: 50 },
                '江苏省': { wind: 26, solar: 34, hydro: 8, thermal: 40 },
                '浙江省': { wind: 16, solar: 28, hydro: 12, thermal: 30 },
                '陕西省': { wind: 30, solar: 22, hydro: 10, thermal: 35 },
                '青海省': { wind: 22, solar: 40, hydro: 18, thermal: 12 },
                '四川省': { wind: 14, solar: 18, hydro: 60, thermal: 12 },
                '云南省': { wind: 20, solar: 22, hydro: 55, thermal: 10 },
                '辽宁省': { wind: 25, solar: 18, hydro: 8, thermal: 35 },
                '内蒙古自治区': { wind: 55, solar: 48, hydro: 5, thermal: 20 },
                '新疆维吾尔自治区': { wind: 50, solar: 52, hydro: 8, thermal: 18 }
            });

            const [resourceLabels, setResourceLabels] = useState({
                wind: '风电装机 (GW)',
                solar: '光伏装机 (GW)',
                hydro: '水电装机 (GW)',
                thermal: '火电装机 (GW)'
            });

            const [resourceMetric, setResourceMetric] = useState('wind');
            const [resourceInput, setResourceInput] = useState('');
            const [gridPreview, setGridPreview] = useState(null);

            // A. 二次调频数据 (Frequency Data) - 沿用之前的数据
            const frequencyData = {
                mapValues: {
                    '河北省': 5000, '河南省': 4000, '广东省': 5000,
                    '山西省': 4100, '甘肃省': 2500, '宁夏回族自治区': 500
                },
                details: {
                    '河北省': {
                        title: '河北省 (南网)', totalVolume: '5000万元 (储能份额)',
                        marketVolumeDisplay: '每月储能分摊份额约 5000万元',
                        tags: ['热度最高', '2026开放'],
                        details: [{ label: '数据来源', value: '河北南网交易中心市场处主任' }]
                    },
                    '河南省': {
                        title: '河南省', totalVolume: '4000万元 (储能份额)',
                        marketVolumeDisplay: '每月储能分摊份额约 4000万元',
                        tags: ['热度高', '2027开放'],
                        details: [{ label: '数据来源', value: '河南调度计划处主任' }]
                    },
                    '广东省': {
                        title: '广东省', totalVolume: '5000万元',
                        marketVolumeDisplay: '每月独立储能市场总量 5000万元左右',
                        tags: ['数据详实', '收益占比90%'],
                        details: [{ label: '数据来源', value: '5-7月收益表' }]
                    },
                    '山西省': {
                        title: '山西省', totalVolume: '4100万元',
                        marketVolumeDisplay: '每月市场总量 4100万元',
                        tags: ['市场成熟', '占比80%'],
                        details: [{ label: '数据来源', value: '实地调研 (1-3月收益表)' }]
                    },
                    '甘肃省': {
                        title: '甘肃省', totalVolume: '2500-2600万元',
                        marketVolumeDisplay: '25年7-9月调频总额连续上行至约2500-2600万元，同比去年同期抬升',
                        tags: ['趋势上涨', '半公开披露'],
                        details: [
                            { label: '数据来源', value: '甘肃电力交易中心半公开披露信息' },
                            { label: '最新进展', value: '8、9月已上涨至约2600万元' }
                        ]
                    },
                    '宁夏回族自治区': {
                        title: '宁夏回族自治区', totalVolume: '500万元',
                        marketVolumeDisplay: '每月总量 500万元左右',
                        tags: ['涨幅不大', '占比5%'],
                        details: [{ label: '数据来源', value: '实地调研' }]
                    }
                },
                provincePoints: {
                    '甘肃省': [
                        { name: '陇东基地', coord: [107.63, 35.73], type: 'F', label: '陇东煤电基地', desc: '坑口煤电+外送中心' },
                        { name: '刘家峡', coord: [103.35, 35.93], type: 'S', label: '黄河梯级水电', desc: '刘家峡调峰主力' }
                    ],
                    '宁夏回族自治区': [
                        { name: '宁东基地', coord: [106.66, 38.16], type: 'F', label: '宁东能源化工', desc: '煤电+化工+光伏' },
                        { name: '腾格里', coord: [105.00, 37.60], type: 'N', label: '腾格里基地', desc: '沙漠光伏/风电' },
                        { name: '中宁换流站', coord: [105.67, 37.48], type: 'S', label: '中宁换流站', desc: '宁电入湘送端' }
                    ],
                    '河南省': [
                        { name: '平顶山', coord: [113.19, 33.76], type: 'F', label: '平顶山煤电', desc: '中原煤电中心' },
                        { name: '豫西风电', coord: [111.50, 34.50], type: 'N', label: '豫西风电', desc: '洛阳西部山区' },
                        { name: '豫东光伏', coord: [114.50, 34.60], type: 'N', label: '豫东光伏', desc: '开封周边集中式' }
                    ],
                    '河北省': [
                        { name: '石家庄', coord: [114.48, 38.03], type: 'F', label: '石家庄热电', desc: '省会负荷中心' },
                        { name: '冀南光伏', coord: [115.68, 37.73], type: 'N', label: '冀南光伏', desc: '衡水平原光伏带' }
                    ],
                    '广东省': [
                        { name: '粤西煤电', coord: [110.35, 21.27], type: 'F', label: '粤西煤电', desc: '湛江沿海基地' },
                        { name: '粤东煤电', coord: [116.37, 23.55], type: 'F', label: '粤东煤电', desc: '揭阳/惠来基地' },
                        { name: '阳江风电', coord: [111.98, 21.4], type: 'N', label: '阳江海上风电', desc: '近海风电集群' },
                        { name: '汕尾风电', coord: [115.6, 22.6], type: 'N', label: '汕尾海上风电', desc: '甲子海域' }
                    ]
                },
                provinceBelts: {
                    '甘肃省': [{ name: '河西走廊新能源带', type: 'N', coords: [[98.50, 39.75], [96.5, 40.5]], label: '酒泉-瓜州-玉门 基地带' }],
                    '河南省': [{ name: '豫北煤电带', type: 'F', coords: [[114.35, 36.10], [114.29, 35.74]], label: '安阳-鹤壁 煤电带' }],
                    '河北省': [{ name: '冀南钢铁煤电带', type: 'F', coords: [[114.50, 37.06], [114.47, 36.60]], label: '邢台-邯郸 煤电钢铁带' }],
                    '广东省': [{ name: '珠江口核电走廊', type: 'S', coords: [[112.93, 21.92], [114.54, 22.60], [114.8, 22.7]], label: '珠江口核电走廊' }]
                }
            };

            const gansuUnifiedOverlay = {
                points: [
                    { name: '河西新能源基地群', coord: [97.3, 39.8], type: 'N', label: '酒泉-瓜州-玉门 风光基地', desc: '河西走廊风光大基地集群' },
                    { name: '张掖枢纽', coord: [100.45, 38.93], type: 'N', label: '张掖枢纽', desc: '新能源集结/送出节点' },
                    { name: '金昌枢纽', coord: [102.2, 38.52], type: 'N', label: '金昌-武威通道', desc: '河西并网汇集' },
                    { name: '兰州负荷中心', coord: [103.84, 36.06], type: 'L', label: '河东负荷中心', desc: '兰州-白银-定西负荷中心' },
                    { name: '陇东联络', coord: [107.0, 35.6], type: 'L', label: '陇东—陕北联络', desc: '庆阳/平凉方向负荷' }
                ],
                belts: [
                    { name: '河西新能源走廊', type: 'N', coords: [[95.5, 40.6], [101.4, 40.3], [101.2, 39.2], [95.3, 39.3]], label: '河西新能源走廊' },
                    { name: '河东负荷区', type: 'L', coords: [[102.6, 36.9], [106.5, 36.6], [106.2, 35.1], [102.2, 35.4]], label: '河东负荷中心' }
                ],
                connections: [
                    { coords: [[97.3, 39.8], [103.84, 36.06]], type: 'N', label: '河西—河东主干网', desc: '新能源外送主力通道', width: 3 },
                    { coords: [[97.3, 39.8], [100.45, 38.93]], type: 'N', label: '酒泉—张掖', desc: '风光基地并网', width: 2 },
                    { coords: [[100.45, 38.93], [102.2, 38.52]], type: 'N', label: '张掖—金昌', desc: '河西主支架', width: 2 },
                    { coords: [[102.2, 38.52], [103.84, 36.06]], type: 'N', label: '金昌—兰州', desc: '接入河东负荷', width: 2 },
                    { coords: [[103.84, 36.06], [107.0, 35.6]], type: 'L', label: '兰州—陇东', desc: '东部负荷/外送', width: 2 },
                    { coords: [[103.84, 36.06], [101.0, 35.9]], type: 'S', label: '兰州—青海联络', desc: '联络青海电网', width: 2, curveness: 0.15 },
                    { coords: [[103.84, 36.06], [105.7, 37.5]], type: 'S', label: '兰州—宁夏联络', desc: '联络宁夏电网', width: 2, curveness: 0.12 },
                    { coords: [[107.0, 35.6], [108.8, 34.9]], type: 'S', label: '陇东—关中', desc: '向陕甘两向送出', width: 2, curveness: 0.12 }
                ]
            };

            // B. 电能量数据 (Energy Data)
            const rawEnergyPriceData = {
                '北京市': { range: [0.318, 0.596], display: '0.318~0.596 元/kWh', note: '华北：峰谷价差区间', category: 'market' },
                '天津市': { value: 0.51, display: '0.51 元/kWh', note: '华北：单次谷充峰放测算', category: 'market' },
                '河北省': { range: [0.43, 0.6], display: '0.43–0.6 元/kWh', note: '两充两放价差约 0.43；一充一放约 0.6', category: 'actual' },
                '山东省': { value: 0.601, display: '0.601 元/kWh', note: '华北：单次谷充峰放', category: 'market' },
                '山西省': { value: 0.45, display: '0.45 元/kWh', note: '华北：测算价差', category: 'actual' },
                '安徽省': { range: [0.257, 0.607], display: '0.257~0.607 元/kWh', note: '华东：峰谷价差区间', category: 'market' },
                '福建省': { range: [0.216, 0.452], display: '0.216~0.452 元/kWh', note: '华东：峰谷价差区间', category: 'market' },
                '上海市': { value: 0.679, display: '0.679 元/kWh（只能做一次谷充峰放）', note: '华东：单次操作', category: 'market' },
                '江苏省': { value: 0.2, display: '0.2 元/kWh', note: '华东：实测价差', category: 'actual' },
                '浙江省': { value: 0.1, display: '0.1 元/kWh', note: '华东：实测价差', category: 'actual' },
                '河南省': { value: 0.4, display: '0.4 元/kWh', note: '华中：实测价差', category: 'actual' },
                '湖北省': { range: [0.229, 0.562], display: '0.229~0.562 元/kWh（全年 2 小时尖峰）', note: '华中：两小时尖峰窗口', category: 'market' },
                '湖南省': { range: [0.246, 0.492], display: '0.246~0.492 元/kWh', note: '华中：峰谷价差区间', category: 'market' },
                '江西省': { range: [0.273, 0.547], display: '0.273~0.547 元/kWh', note: '华中：峰谷价差区间', category: 'market' },
                '吉林省': { value: 0.469, display: '0.469 元/kWh', note: '东北：单次谷充峰放', category: 'market' },
                '黑龙江省': { value: 0.395, display: '0.395 元/kWh', note: '东北：单次谷充峰放', category: 'market' },
                '辽宁省': { value: 0.423, display: '0.423 元/kWh', note: '东北：单次谷充峰放', category: 'market' },
                '内蒙古自治区': { range: [0.223, 0.407], display: '蒙东：0.342；蒙西：0.223~0.407 元/kWh', note: '蒙东全年两次谷段充电 + 高峰放电；蒙西为峰谷区间', category: 'market' },
                '甘肃省': { value: 0.27, display: '0.27 元/kWh（河西均价约 0.27）', note: '454 个节点，河西均价约 0.27', category: 'actual' },
                '宁夏回族自治区': { value: 0.32, display: '0.32 元/kWh（可做金融套利）', note: '可做金融套利', category: 'actual' },
                '青海省': { range: [0.231, 0.455], display: '0.231~0.455 元/kWh', note: '西北：峰谷价差区间', category: 'market' },
                '陕西省': { value: 0.4, display: '0.4 元/kWh', note: '西北：实测价差', category: 'actual' },
                '新疆维吾尔自治区': { range: [0.136, 0.290], display: '0.136~0.290 元/kWh', note: '西北：峰谷价差区间', category: 'market' },
                '四川省': { range: [0.166, 0.332], display: '0.166~0.332 元/kWh', note: '西南：峰谷价差区间', category: 'market' },
                '重庆市': { range: [0.262, 0.533], display: '0.262~0.533 元/kWh', note: '西南：峰谷价差区间', category: 'market' },
                '广东省': { value: 0.18, display: '0.18 元/kWh', note: '南网：实测价差', category: 'actual' },
                '广西壮族自治区': { range: [0.205, 0.411], display: '0.205~0.411 元/kWh', note: '南网：峰谷价差区间', category: 'market' },
                '贵州省': { range: [0.231, 0.463], display: '0.231~0.463 元/kWh', note: '南网：峰谷价差区间', category: 'market' },
                '云南省': { value: 0.28, display: '0.28 元/kWh', note: '南网：单次谷充峰放', category: 'market' },
                '海南省': { range: [0.397, 0.737], display: '0.397~0.737 元/kWh', note: '南网：峰谷价差区间', category: 'market' }
            };

            const provinceReportNotes = {
                '青海省': {
                    summary: '截至2025年9月8日，全口径装机容量约 7728.525 万千瓦，新能源装机占比 72.13%，风光装机比例约 3:1，西部西宁主力电网与中部电网相连。',
                    extraTags: ['装机 7728.525 万千瓦', '新能源占比 72.13%'],
                    details: [
                        {
                            label: '能源与电网概况',
                            value: '水电 1639.218 万千瓦（21.21%）、火电 699.200 万千瓦（9.04%）、风电 1353.315 万千瓦（17.51%）、太阳能 3547.29 万千瓦（45.90%）、储能 519.44 万千瓦（6.71%）。'
                        },
                        {
                            label: '电网频率与外送通道',
                            value: '单一电网与外送通道较为薄弱，西部西宁主力电网与中部电网相连，电力以外送为主，电网通道数量较少。'
                        }
                    ]
                },
                '甘肃省': {
                    summary: '截至2025年9月，装机容量约 11162.75 万千瓦，新能源装机占比 58.65%，风光装机占比超过 58%。',
                    extraTags: ['装机 11162.75 万千瓦', '新能源占比 58.65%'],
                    details: [
                        {
                            label: '能源与电网概况',
                            value: '火电 3017.51 万千瓦（27.13%）、水电 971.28 万千瓦（8.70%）、风电 3710.80 万千瓦（33.27%）、太阳能 2803.93 万千瓦（25.12%）、储能 659.48 万千瓦（5.91%）。'
                        },
                        {
                            label: '电网频率与外送通道',
                            value: '电网频率高，双向并网，网强度高且外送通道较多，线路包括双回路，出口以多个直流外送通道为主。'
                        },
                        {
                            label: '电力负荷与需求',
                            value: '电力负荷需求较高，工业用电为主，工商业负荷占比较大，电力供应较为紧张。'
                        }
                    ]
                }
            };

            const buildEnergyData = () => {
                const mapValues = {};
                const details = {};
                const categoryMap = {};
                const displayMap = {};
                const noteMap = {};
                const rangeMap = {};
                const actualValues = [];
                const marketValues = [];

                Object.entries(rawEnergyPriceData).forEach(([name, info]) => {
                    const midValue = info.value ?? (((info.range?.[0] || 0) + (info.range?.[1] || 0)) / 2);
                    mapValues[name] = midValue;
                    categoryMap[name] = info.category;
                    displayMap[name] = info.display;
                    noteMap[name] = info.note;
                    rangeMap[name] = info.range;
                    (info.category === 'actual' ? actualValues : marketValues).push(midValue);

                    const baseDetails = {
                        title: `${name} 电能量价差`,
                        totalVolume: info.display,
                        marketVolumeDisplay: info.note ? `${info.display} ｜ ${info.note}` : info.display,
                        tags: [info.category === 'actual' ? '实测数据' : '市场区间', info.range ? '提供范围' : '单点数据'],
                        details: [
                            { label: '价格/价差', value: info.display },
                            ...(info.range ? [{ label: '范围数值', value: `${info.range[0]} ~ ${info.range[1]} 元/kWh` }] : []),
                            info.note ? { label: '备注', value: info.note } : null
                        ].filter(Boolean)
                    };

                    const report = provinceReportNotes[name];
                    if (report) {
                        baseDetails.marketVolumeDisplay = `${baseDetails.marketVolumeDisplay} ｜ ${report.summary}`;
                        if (Array.isArray(report.extraTags)) {
                            baseDetails.tags = [...baseDetails.tags, ...report.extraTags];
                        }
                        if (Array.isArray(report.details)) {
                            baseDetails.details.push(...report.details);
                        }
                    }

                    details[name] = baseDetails;
                });

                const calcRange = (values) => {
                    if (!values.length) return { min: 0, max: 1 };
                    return { min: Math.min(...values), max: Math.max(...values) };
                };

                return {
                    mapValues,
                    details,
                    categoryMap,
                    displayMap,
                    noteMap,
                    rangeMap,
                    ranges: {
                        actual: calcRange(actualValues),
                        market: calcRange(marketValues)
                    }
                };
            };

            const energyData = buildEnergyData();

            const overviewData = useMemo(() => {
                const freqProvinces = Object.keys(frequencyData.mapValues || {});
                const energyProvinces = Object.keys(energyData.mapValues || {});
                const overviewValues = {};
                const overviewDetails = {};
                const categoryMap = {};

                freqProvinces.forEach(name => {
                    overviewValues[name] = 2;
                    categoryMap[name] = 'frequency';
                    overviewDetails[name] = {
                        title: `${name} ｜ 调频省份`,
                        totalVolume: frequencyData.details?.[name]?.totalVolume || '调频热点',
                        marketVolumeDisplay: frequencyData.details?.[name]?.marketVolumeDisplay || '调频市场重点省份',
                        tags: ['调频', '全国概览'],
                        details: frequencyData.details?.[name]?.details || []
                    };
                });

                energyProvinces.forEach(name => {
                    if (!overviewValues[name]) {
                        overviewValues[name] = 1;
                        categoryMap[name] = 'energy';
                        overviewDetails[name] = {
                            title: `${name} ｜ 电能量省份`,
                            totalVolume: energyData.details?.[name]?.totalVolume || energyData.displayMap?.[name] || '电能量热点',
                            marketVolumeDisplay: energyData.details?.[name]?.marketVolumeDisplay || '电能量市场重点省份',
                            tags: ['电能量', '全国概览'],
                            details: energyData.details?.[name]?.details || []
                        };
                    }
                });

                return {
                    mapValues: overviewValues,
                    details: overviewDetails,
                    categoryMap
                };
            }, [frequencyData, energyData]);

            // 资源禀赋动态视图
            const resourceMetrics = useMemo(() => {
                const keys = new Set();
                Object.values(resourceEndowment || {}).forEach(item => {
                    Object.keys(item || {}).forEach(k => keys.add(k));
                });
                return Array.from(keys);
            }, [resourceEndowment]);

            const resourceRange = useMemo(() => {
                const values = Object.values(resourceEndowment || {}).map(v => Number(v?.[resourceMetric]) || 0);
                if (!values.length) return { min: 0, max: 1 };
                return { min: Math.min(...values), max: Math.max(...values) };
            }, [resourceEndowment, resourceMetric]);

            const resourceData = useMemo(() => {
                const mapValues = {};
                const details = {};

                Object.entries(resourceEndowment || {}).forEach(([province, metrics]) => {
                    const value = Number(metrics?.[resourceMetric]) || 0;
                    const total = Object.values(metrics || {}).reduce((sum, v) => sum + (Number(v) || 0), 0);
                    const pieData = Object.entries(metrics || {}).map(([k, v]) => ({
                        name: resourceLabels[k] || k,
                        value: Number(v) || 0,
                        key: k
                    })).sort((a, b) => b.value - a.value);

                    mapValues[province] = value;
                    details[province] = {
                        title: `${province} 资源禀赋`,
                        totalVolume: `${resourceLabels[resourceMetric] || resourceMetric}: ${value} GW`,
                        marketVolumeDisplay: `合计装机约 ${total.toFixed(1)} GW，点击下方饼图查看结构`,
                        tags: ['资源禀赋', '可编辑', resourceLabels[resourceMetric] || resourceMetric],
                        resourcePieData: pieData,
                        details: pieData.map(item => ({ label: item.name, value: `${item.value} GW` }))
                    };
                });

                return { mapValues, details };
            }, [resourceEndowment, resourceMetric, resourceLabels]);

            // C. 电能量政策热力数据
            const policyLevelConfig = {
                1: { label: '无政策', desc: '暂无储能相关中长期/现货政策' },
                2: { label: '经营主体包含储能', desc: '经营主体层面明确包含储能' },
                3: { label: '交易细则包含储能', desc: '交易细则明确覆盖储能' }
            };

            const spotProgressLevelText = {
                0: '暂无现货市场进展或表格未给出信息',
                1: '模拟/调电试运行',
                2: '短周期结算试运行',
                3: '长周期结算试运行',
                4: '连续结算试运行',
                5: '正式运行'
            };

            const provinceAlias = {
                '北京': '北京市', '天津': '天津市', '河北南网': '河北省', '冀北': '河北省',
                '山东': '山东省', '山西': '山西省', '安徽': '安徽省', '福建': '福建省',
                '上海': '上海市', '江苏': '江苏省', '浙江': '浙江省', '湖北': '湖北省',
                '湖南': '湖南省', '河南': '河南省', '江西': '江西省', '吉林': '吉林省',
                '黑龙江': '黑龙江省', '辽宁': '辽宁省', '甘肃': '甘肃省', '宁夏': '宁夏回族自治区',
                '青海': '青海省', '陕西': '陕西省', '新疆': '新疆维吾尔自治区', '四川': '四川省',
                '重庆': '重庆市', '广东': '广东省', '广西': '广西壮族自治区', '贵州': '贵州省',
                '云南': '云南省', '海南': '海南省', '蒙西': '内蒙古自治区', '蒙东': '内蒙古自治区',
                '省间（国网、蒙西）': '跨省（国网-蒙西）', '省间(国网与蒙西)': '跨省（国网-蒙西）', '南方区域': '南方区域'
            };

            const normalizeProvince = (name) => provinceAlias[name] || name;

            const spotProgressColorScale = ['#f8fafc', '#e7edf5', '#d5deeb', '#b7c6dc', '#8ca3be', '#5b7698']; // 现货进程：柔和灰蓝系

            const spotResearchColorScale = {
                researched: ['#e7f3ff', '#cde6ff', '#9fcfff', '#71b9ff', '#4094f6', '#1f6ed6'],
                unresearched: spotProgressColorScale
            };

            const spotResearchLabelMap = {
                'researched-active': '已调研（储能参与现货）',
                'researched-upcoming': '已调研（即将对储能开放）',
                'not-open': '未对储能实际开放'
            };

            const spotResearchStatusMap = {};
            const setResearchStatus = (names, status) => names.forEach(name => {
                const normalized = normalizeProvince(name);
                spotResearchStatusMap[normalized] = status;
            });

            setResearchStatus(['宁夏回族自治区', '甘肃省', '山西省', '山东省', '蒙西', '广东省', '河北南网'], 'researched-active');
            setResearchStatus(['河南省', '陕西省', '江苏省'], 'researched-upcoming');
            setResearchStatus(['浙江省'], 'not-open');

            const buildPolicyData = (entries, title) => {
                const mapValues = {};
                const details = {};
                const labelMap = {};

                entries.forEach(([rawName, value]) => {
                    const name = normalizeProvince(rawName);
                    const level = Math.max(mapValues[name] ?? 1, value ?? 1);
                    mapValues[name] = level;

                    const levelInfo = policyLevelConfig[level] || policyLevelConfig[1];
                    labelMap[name] = levelInfo.label;
                    details[name] = {
                        title: `${name} ${title}`,
                        totalVolume: `政策：${levelInfo.label}`,
                        marketVolumeDisplay: levelInfo.desc,
                        tags: [title, levelInfo.label],
                        heatValue: level,
                        details: [
                            { label: '政策', value: levelInfo.label },
                            { label: '说明', value: levelInfo.desc }
                        ]
                    };
                });

                return { mapValues, details, labelMap };
            };

            const buildSpotProgressData = (entries, longPolicyData, spotPolicyData) => {
                const mapValues = {};
                const details = {};
                const remarkMap = {};
                const policyMap = {};
                const levelLabelMap = {};
                const policyLabelMap = {};

                entries.forEach(([rawName, rawLevel, remark]) => {
                    const name = normalizeProvince(rawName);
                    const level = Math.max(0, Math.min(5, Number(rawLevel) || 0));
                    const currentLevel = mapValues[name] ?? 0;
                    const finalLevel = level > currentLevel ? level : currentLevel;
                    const researchStatus = spotResearchStatusMap[name];
                    const researchLabel = researchStatus ? spotResearchLabelMap[researchStatus] : '未调研';

                    const longPolicyLevel = longPolicyData?.mapValues?.[name];
                    const spotPolicyLevel = spotPolicyData?.mapValues?.[name];
                    const levelLabel = spotProgressLevelText[finalLevel] || spotProgressLevelText[0];
                    const longPolicyLabel = longPolicyData?.labelMap?.[name] || (longPolicyLevel ? policyLevelConfig[longPolicyLevel]?.label : null);
                    const spotPolicyLabel = spotPolicyData?.labelMap?.[name] || (spotPolicyLevel ? policyLevelConfig[spotPolicyLevel]?.label : null);

                    if (adcodeMap[name]) {
                        mapValues[name] = finalLevel;
                    }

                    remarkMap[name] = remark;
                    policyMap[name] = { long: longPolicyLevel, spot: spotPolicyLevel };
                    levelLabelMap[name] = levelLabel;
                    policyLabelMap[name] = { long: longPolicyLabel, spot: spotPolicyLabel };
                    details[name] = {
                        title: `${name} 现货市场进程`,
                        totalVolume: `成熟度：${levelLabel}`,
                        marketVolumeDisplay: remark || '暂无备注信息',
                        tags: [
                            '现货市场进程',
                            levelLabel,
                            longPolicyLabel ? `中长期政策：${longPolicyLabel}` : null,
                            spotPolicyLabel ? `现货政策：${spotPolicyLabel}` : null,
                            researchLabel
                        ].filter(Boolean),
                        heatValue: finalLevel,
                        remark,
                        researchStatus,
                        researchLabel,
                        details: [
                            { label: '成熟度', value: levelLabel },
                            remark ? { label: '进展说明', value: remark } : null,
                            longPolicyLabel ? { label: '中长期政策', value: longPolicyLabel } : null,
                            spotPolicyLabel ? { label: '现货政策', value: spotPolicyLabel } : null,
                            { label: '储能调研', value: researchLabel }
                        ].filter(Boolean)
                    };
                });

                return { mapValues, details, remarkMap, policyMap, levelLabelMap, policyLabelMap, researchStatusMap: spotResearchStatusMap };
            };

            const longTermPolicyData = buildPolicyData([
                ['北京', 1], ['天津', 3], ['河北南网', 3], ['冀北', 3], ['山东', 2], ['山西', 2],
                ['安徽', 3], ['福建', 3], ['上海', 2], ['江苏', 2], ['浙江', 2], ['湖北', 2],
                ['湖南', 2], ['河南', 2], ['江西', 2], ['吉林', 3], ['黑龙江', 3], ['辽宁', 2],
                ['甘肃', 2], ['宁夏', 3], ['青海', 3], ['陕西', 3], ['新疆', 3], ['四川', 3],
                ['重庆', 2], ['蒙西', 2], ['广东', 3], ['广西', 3], ['贵州', 3], ['云南', 2], ['海南', 3]
            ], '中长期政策');

            const spotPolicyData = buildPolicyData([
                ['北京', 1], ['天津', 1], ['河北南网', 3], ['冀北', 1], ['山东', 3], ['山西', 3],
                ['安徽', 3], ['福建', 3], ['上海', 2], ['江苏', 3], ['浙江', 3], // 浙江目前不参与现货
                ['湖北', 3],
                ['湖南', 3], ['河南', 3], ['江西', 3], ['吉林', 3], ['黑龙江', 3], ['辽宁', 3],
                ['甘肃', 3], ['宁夏', 3], ['青海', 3], ['陕西', 3], ['新疆', 3], ['四川', 3],
                ['重庆', 3], ['蒙西', 3], ['广东', 3], ['广西', 3], ['贵州', 3], ['云南', 3], ['海南', 3]
            ], '现货政策');

            const spotProgressData = buildSpotProgressData([
                ['北京', 0, '表格中未给出北京现货市场进程的具体说明'],
                ['天津', 0, '表格中未给出天津现货市场进程的具体说明'],
                ['河北南网', 4, '2023年9月开始首次结算试运行，2024年11月进行第二轮长周期结算试运行，2025年3月1日起开展连续结算试运行'],
                ['冀北', 0, '表格中未给出冀北现货市场进程的具体说明'],
                ['山东', 5, '自2021年12月起开展长周期不间断结算试运行并持续推进，2024年6月17日转入现货市场正式运行'],
                ['山西', 5, '2021年4月起连续三个月开展结算试运行，2023年12月22日转入现货市场正式运行'],
                ['安徽', 4, '2024年5月进行第一次整月结算试运行，2024年12月31日起开展连续结算试运行'],
                ['福建', 3, '2024年11月开展首次全月结算试运行，2025年3月进入长周期结算试运行阶段'],
                ['上海', 4, '2025年初多次结算试运行并在5月完成整月结算试运行，同年10月29日启动连续结算试运行'],
                ['江苏', 4, '2024年12月完成第六次结算试运行，2025年6月1日开展长周期结算试运行并于9月起进入连续结算试运行'],
                ['浙江', 5, '2024年5月启动长周期连续结算试运行，2025年8月7日起转入现货市场正式运行'],
                ['湖北', 5, '2024年4月16日开展第二轮长周期结算试运行，2025年6月6日起转入现货市场正式运行'],
                ['湖南', 4, '2024年11月开展首次整月结算试运行和后续结算试运行，2025年10月28日起启动连续结算试运行'],
                ['河南', 3, '2024年5月15日至6月14日开展结算试运行，2025年9月开展整月结算试运行'],
                ['江西', 4, '2023年6月14日首次结算试运行，2025年8月下旬至9月进行调电试运行并于10月1日起进入连续结算阶段'],
                ['吉林', 4, '2024年11月中旬进行第一次结算试运行，2025年7月2日完成首次整月结算，并从9月1日起启动连续结算试运行'],
                ['黑龙江', 4, '2022年12月先后开展模拟试运行和调电试运行，2025年8月1日起进行连续结算试运行'],
                ['辽宁', 4, '2024年11月开展首次整月结算试运行，2025年3月1日起开展连续结算试运行'],
                ['蒙东', 4, '2025年3月中旬开展首次结算试运行，7月31日完成整月结算试运行并于10月20日转入连续结算试运行'],
                ['甘肃', 5, '2021年5月起开展连续不间断结算试运行，2024年9月5日转入现货市场正式运行'],
                ['宁夏', 4, '2024年11月开展首次整月结算试运行，2025年5月下旬至7月开展多次结算试运行并计划自10月1日起进入连续结算试运行'],
                ['青海', 4, '2024年11月上旬首次结算试运行，2025年多次结算试运行后自10月28日起开始连续试运行'],
                ['陕西', 4, '2024年5月15日至6月13日开展整月结算试运行，并于2024年12月31日进入连续结算试运行'],
                ['新疆', 4, '2024年12月下旬及2025年多次开展结算试运行，2025年10月11日转入更高级别的连续运行阶段'],
                ['四川', 3, '2020年9月进行水电竞价连续720小时结算试运行，2022年7月开展水电现货调电试运行，2025年6月至9月安排模拟试运行'],
                ['重庆', 4, '2024年11月完成首次整月结算试运行，2025年5月至6月进行长周期多月结算试运行并计划自11月1日起启动连续结算试运行'],
                ['蒙西', 5, '2022年6月1日启动连续结算试运行，2025年2月24日转入现货市场正式运行'],
                ['省间（国网、蒙西）', 5, '2022年1月启动试运行，2024年10月15日转入正式运行'],
                ['广东', 5, '2019年5月启动现货市场结算试运行，2023年12月28日转入正式运行'],
                ['广西', 4, '2024年11月开展全月结算试运行，2025年6月29日起转入连续结算试运行'],
                ['贵州', 4, '2024年11月开展全月结算试运行，2025年6月29日起转入连续结算试运行'],
                ['云南', 4, '2024年11月开展全月结算试运行，2025年6月29日起转入连续结算试运行'],
                ['海南', 4, '2024年11月开展全月结算试运行，2025年6月29日起转入连续结算试运行'],
                ['南方区域', 4, '南方区域整体在2024年11月开展全月结算试运行并于2025年6月29日起进入连续结算试运行'],
                ['省间(国网与蒙西)', 6, '省间现货市场自2022年1月启动试运行并于2024年10月15日转入正式运行']
            ], longTermPolicyData, spotPolicyData);

            // --- 辅助数据 ---
            const deepBlueProvinces = ['江苏省', '浙江省', '安徽省', '山东省'];
            const blueProvinces = ['贵州省', '云南省', '广西壮族自治区', '湖南省', '湖北省', '江西省', '内蒙古自治区'];
            const lightBlueProvinces = ['新疆维吾尔自治区', '黑龙江省', '吉林省', '辽宁省', '青海省'];

            const actualDataProvinces = ['河北省', '山西省', '江苏省', '浙江省', '河南省', '甘肃省', '宁夏回族自治区', '陕西省', '广东省'];

            const energyColorScale = {
                actual: [...brandBlueScale],
                market: ['#f8fafc', '#e2e8f0', '#cbd5e1', '#94a3b8', '#475569', '#1f2937']
            };

            const formatPriceLabel = (value) => {
                if (!isFinite(value)) return '--';
                return value >= 1 ? value.toFixed(1) : value.toFixed(2);
            };

            const buildScaleLabels = ({ min, max }) => {
                if (!isFinite(min) || !isFinite(max)) return [];
                if (min === max) return [max];
                return [max, min];
            };

            const actualScaleLabels = buildScaleLabels(energyData.ranges.actual);
            const marketScaleLabels = buildScaleLabels(energyData.ranges.market);

            const getResourceColor = (value) => {
                const { min, max } = resourceRange;
                const palette = colorPalettes.resource.map;
                const safeSpan = max - min || 1;
                const ratio = Math.min(1, Math.max(0, (value - min) / safeSpan));
                const idx = Math.min(palette.length - 1, Math.floor(ratio * (palette.length - 1)));
                return palette[idx];
            };

            const getEnergyColor = (value, category) => {
                const palette = energyColorScale[category === 'actual' ? 'actual' : 'market'];
                const { min, max } = energyData.ranges[category === 'actual' ? 'actual' : 'market'];
                const safeSpan = max - min || 1;
                const ratio = Math.min(1, Math.max(0, safeSpan === 0 ? 0.5 : (value - min) / safeSpan));
                const idx = Math.min(palette.length - 1, Math.floor(ratio * (palette.length - 1)));
                return palette[idx];
            };

            // --- 数据选择逻辑 ---
            const currentData = useMemo(() => {
                if (marketType === 'overview') return overviewData;
                if (marketType === 'frequency') return frequencyData;
                if (energyView === 'spot-progress') return spotProgressData;
                if (marketType === 'resource') return resourceData;
                return energyData;
            }, [marketType, energyView, resourceData, overviewData]);

            // --- 数据转换函数 ---
            const withAlpha = (hexColor, alpha) => {
                if (!hexColor || typeof hexColor !== 'string') return `rgba(14,165,233,${alpha})`;
                if (!hexColor.startsWith('#')) return hexColor;
                const hex = hexColor.replace('#', '');
                const normalized = hex.length === 3
                    ? hex.split('').map(ch => ch + ch).join('')
                    : hex.padEnd(6, '0');
                const r = parseInt(normalized.slice(0, 2), 16) || 14;
                const g = parseInt(normalized.slice(2, 4), 16) || 165;
                const b = parseInt(normalized.slice(4, 6), 16) || 233;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            const convertPointData = (data) => {
                if(!data) return [];
                return data.map(item => {
                    const cfg = pointTypeConfig[item.type];
                    return {
                        name: item.name,
                        value: item.coord.concat(100),
                        symbol: cfg?.symbol || 'circle',
                        itemStyle: {
                            color: cfg?.color || '#666',
                            borderColor: '#fff', borderWidth: 2, shadowBlur: 5, shadowColor: 'rgba(0,0,0,0.5)'
                        },
                        tooltipData: item
                    };
                });
            };

            const convertBeltPolygonData = (data) => {
                if(!data) return [];
                return data.map(item => {
                    const cfg = pointTypeConfig[item.type];
                    const baseColor = cfg?.beltColor || '#38bdf8';
                    return {
                        coords: item.coords,
                        name: item.label,
                        fillColor: withAlpha(baseColor, 0.18),
                        strokeColor: withAlpha(baseColor, 0.6),
                        tooltipData: { label: item.label, desc: '区域/走廊/产业带', type: item.type }
                    };
                });
            };

            const convertConnectionData = (data) => {
                if (!data) return [];
                return data.map(item => {
                    const cfg = pointTypeConfig[item.type];
                    return {
                        coords: item.coords,
                        lineStyle: {
                            color: cfg?.color || '#0f172a',
                            width: item.width || 2,
                            opacity: item.opacity || 0.9,
                            type: item.dashed ? 'dashed' : 'solid',
                            curveness: item.curveness || 0
                        },
                        tooltipData: { label: item.label, desc: item.desc, type: item.type }
                    };
                });
            };
            
            // 生成热力图数据 (根据当前市场类型)
            const generateMapData = () => {
                const data = [];
                const values = currentData.mapValues || {};

                Object.keys(values).forEach(name => {
                    if (marketType === 'overview') {
                        const category = currentData.categoryMap?.[name] || 'energy';
                        const color = category === 'frequency' ? colorPalettes.overview.map[2] : colorPalettes.overview.map[1];
                        data.push({
                            name,
                            value: values[name],
                            itemStyle: { areaColor: color, borderColor: '#fff', borderWidth: 1.2 },
                            emphasis: { itemStyle: { areaColor: currentPalette.highlight } },
                            overviewCategory: category
                        });
                    } else if (marketType === 'energy') {
                        if (energyView === 'price') {
                            const category = energyData.categoryMap[name];
                            const color = getEnergyColor(values[name], category);
                            data.push({
                                name,
                                value: values[name],
                                itemStyle: { areaColor: color, borderColor: '#fff', borderWidth: 1.2 },
                                emphasis: { itemStyle: { areaColor: currentPalette.highlight } },
                                energyCategory: category
                            });
                        } else if (energyView === 'spot-progress') {
                            const level = values[name] ?? 0;
                            const remark = currentData.remarkMap?.[name];
                            const policyInfo = currentData.policyMap?.[name];
                            const levelLabel = currentData.levelLabelMap?.[name] || spotProgressLevelText[level] || spotProgressLevelText[0];
                            const policyLabels = currentData.policyLabelMap?.[name] || {};
                            const researchStatus = currentData.researchStatusMap?.[name];
                            const researchLabel = researchStatus ? spotResearchLabelMap[researchStatus] : '未调研';
                            const palette = researchStatus?.startsWith('researched') ? spotResearchColorScale.researched : spotResearchColorScale.unresearched;
                            const areaColor = palette[level] || palette[0];
                            data.push({
                                name,
                                value: level,
                                itemStyle: { areaColor, borderColor: '#fff', borderWidth: 1.2 },
                                emphasis: { itemStyle: { areaColor: currentPalette.highlight } },
                                spotProgressLevel: level,
                                spotProgressLabel: levelLabel,
                                remark,
                                longPolicyLevel: policyInfo?.long,
                                spotPolicyLevel: policyInfo?.spot,
                                longPolicyLabel: policyLabels.long,
                                spotPolicyLabel: policyLabels.spot,
                                researchStatus,
                                researchLabel
                            });
                        }
                    } else if (marketType === 'resource') {
                        const color = getResourceColor(values[name]);
                        data.push({
                            name,
                            value: values[name],
                            itemStyle: { areaColor: color, borderColor: '#fff', borderWidth: 1.2 },
                            emphasis: { itemStyle: { areaColor: currentPalette.highlight } }
                        });
                    } else {
                        data.push({ name: name, value: values[name] });
                    }
                });

                // 只有在调频市场时才显示这些特定的蓝梯队背景
                if (marketType === 'frequency') {
                    deepBlueProvinces.forEach(name => !values[name] && data.push({ name, value: -3 }));
                    blueProvinces.forEach(name => !values[name] && data.push({ name, value: -2 }));
                    lightBlueProvinces.forEach(name => !values[name] && data.push({ name, value: -1 }));
                }
                return data;
            };

            // --- 加载地图 ---
            const loadMap = async (mode, provinceName = null) => {
                setLoading(true);
                try {
                    let geoJsonUrl = 'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json';
                    let mapName = 'china';

                    if (mode === 'province' && provinceName) {
                        const adcode = adcodeMap[provinceName];
                        if (adcode) {
                            geoJsonUrl = `https://geo.datav.aliyun.com/areas_v3/bound/${adcode}_full.json`;
                            mapName = provinceName;
                        }
                    }

                    const response = await fetch(geoJsonUrl);
                    const geoJson = await response.json();
                    
                    if (!window.echarts) return;
                    
                    window.echarts.registerMap(mapName, geoJson);
                    
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.dispose();
                    }
                    
                    const chart = window.echarts.init(mapContainerRef.current);
                    chartInstanceRef.current = chart;

                    let option = {};

                    if (mode === 'china') {
                        // === 全国视图 ===
                        const frequencyPieces = [
                            { min: 4900, label: '5000万', color: currentPalette.map[0] },
                            { min: 4050, max: 4899, label: '4100万', color: currentPalette.map[1] },
                            { min: 3000, max: 4049, label: '4000万', color: currentPalette.map[2] },
                            { min: 1000, max: 2999, label: '2500万', color: currentPalette.map[3] },
                            { min: 0, max: 999, label: '500万', color: currentPalette.map[4] },
                            { value: -3, label: '第一梯队', color: '#52525b' },
                            { value: -2, label: '第二梯队', color: '#9ca3af' },
                            { value: -1, label: '第三梯队', color: '#e5e7eb' }
                        ];

                        const overviewPieces = [
                            { value: 2, label: '调频省份', color: colorPalettes.overview.map[2] },
                            { value: 1, label: '电能量省份', color: colorPalettes.overview.map[1] }
                        ];

                        option = {
                            backgroundColor: 'transparent',
                            grid: { left: '5%', right: '5%', top: '5%', bottom: '5%' },
                                tooltip: {
                                    trigger: 'item',
                                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                    borderColor: '#e2e8f0', borderWidth: 1, padding: 12, textStyle: { color: '#1e293b' },
                                    formatter: (params) => {
                                    if (params.data?.overviewCategory) {
                                        const label = params.data.overviewCategory === 'frequency' ? '调频省份' : '电能量省份';
                                        const info = currentData.details?.[params.name];
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                            + `<div style="font-size:12px; color:${params.data.overviewCategory === 'frequency' ? '#0ea5e9' : '#10b981'}; font-weight:700;">${label}</div>`
                                            + (info?.marketVolumeDisplay ? `<div style=\"font-size:12px; color:#475569; margin-top:6px; line-height:1.6;\">${info.marketVolumeDisplay}</div>` : '')
                                            + `<div style="font-size:12px; color:#2563eb; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px; margin-top:6px;">🖱 双击进入省级地图</div>`;
                                    }

                                    if (params.data?.spotProgressLevel !== undefined) {
                                        const level = params.data.spotProgressLevel;
                                        const remark = params.data.remark || currentData.remarkMap?.[params.name];
                                        const researchStatus = params.data.researchStatus || currentData.researchStatusMap?.[params.name];
                                        const palette = researchStatus?.startsWith('researched') ? spotResearchColorScale.researched : spotResearchColorScale.unresearched;
                                        const color = palette[level] || palette[0];
                                        const longPolicy = params.data.longPolicyLevel;
                                        const spotPolicy = params.data.spotPolicyLevel;
                                        const levelLabel = params.data.spotProgressLabel || spotProgressLevelText[level] || spotProgressLevelText[0];
                                        const longPolicyLabel = params.data.longPolicyLabel || (longPolicy ? policyLevelConfig[longPolicy]?.label : '');
                                        const spotPolicyLabel = params.data.spotPolicyLabel || (spotPolicy ? policyLevelConfig[spotPolicy]?.label : '');
                                        const researchLabel = researchStatus ? spotResearchLabelMap[researchStatus] : '未调研（默认灰色系）';
                                        const researchColor = researchStatus?.startsWith('researched') ? '#0038B8' : '#1f2937';
                                        const policyLines = [
                                            longPolicyLabel ? `<div style="font-size:12px; color:#334155;">中长期政策：${longPolicyLabel}</div>` : '',
                                            spotPolicyLabel ? `<div style="font-size:12px; color:#475569;">现货政策：${spotPolicyLabel}</div>` : '',
                                            `<div style="font-size:12px; color:${researchColor};">储能调研：${researchLabel}</div>`
                                        ].join('');
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                            + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">成熟度：<span style="font-weight:bold; color:${color};">${levelLabel}</span></div>`
                                            + policyLines
                                            + (remark ? `<div style="font-size:12px; color:#0f172a; font-weight:500; line-height:1.6;">${remark}</div>` : '')
                                            + `<div style="font-size:12px; color:#2563eb; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px; margin-top:6px;">🖱 双击进入省级地图</div>`;
                                    }

                                    if (params.data?.energyCategory) {
                                        const categoryLabel = params.data.energyCategory === 'actual' ? '实测数据' : '市场区间';
                                        const display = energyData.displayMap[params.name] || params.value;
                                        const note = energyData.noteMap[params.name];
                                        const range = energyData.rangeMap[params.name];
                                        const rangeLine = range ? `<div style="font-size:12px;color:#475569;margin-top:4px;">范围数值：${range[0]} ~ ${range[1]} 元/kWh</div>` : '';
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                            + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">类别：<span style="font-weight:bold; color:${currentPalette.map[1]};">${categoryLabel}</span></div>`
                                            + `<div style="font-size:12px; color:#0ea5e9; font-weight:600;">${display}</div>`
                                            + (note ? `<div style="font-size:12px; color:#64748b; margin-top:4px;">${note}</div>` : '')
                                            + rangeLine
                                            + `<div style="font-size:12px; color:#0ea5e9; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px;">🖱 双击进入省级地图</div>`;
                                    }

                                    if (marketType === 'frequency') {
                                        if (!params.value) return `<div style="color:#94a3b8">${params.name} <br/>暂无数据</div>`;
                                        let colorDot = `<span style="display:inline-block;margin-right:6px;border-radius:50%;width:8px;height:8px;background-color:${Array.isArray(params.color) ? params.color[params.color.length-1] : params.color};"></span>`;
                                        if (params.value > 0) {
                                            const info = currentData.details[params.name] || {};
                                            const volume = info.totalVolume || params.value;
                                            const note = info.marketVolumeDisplay || '';
                                            const categoryLabel = '市场总量';
                                            return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                                    + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">${colorDot} ${categoryLabel}: <span style="font-weight:bold; color:${currentPalette.map[1]};">${volume}</span></div>`
                                                    + (note ? `<div style="font-size:12px; color:#64748b; margin-bottom:4px;">${note}</div>` : '')
                                                    + `<div style="font-size:12px; color:#0ea5e9; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px;">🖱 双击进入省级地图</div>`;
                                        }
                                        return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`;
                                    }

                                    if (marketType === 'energy') {
                                        const info = currentData.details?.[params.name];
                                        if (info) {
                                            return `<div style="font-weight:bold; font-size:14px; margin-bottom:4px;">${params.name}</div>`
                                                + `<div style="font-size:12px; color:#475569; margin-bottom:6px;">${info.totalVolume}</div>`
                                                + `<div style="font-size:12px; color:#0f172a; line-height:1.5;">${info.marketVolumeDisplay}</div>`
                                                + `<div style="font-size:12px; color:#2563eb; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px; margin-top:6px;">🖱 双击进入省级地图</div>`;
                                        }
                                    }

                                    if (marketType === 'resource') {
                                        const info = currentData.details?.[params.name];
                                        if (info) {
                                            return `<div style="font-weight:bold; font-size:14px; margin-bottom:6px;">${params.name}</div>`
                                                + `<div style=\"font-size:12px; color:#047857; font-weight:700; margin-bottom:6px;\">${info.totalVolume}</div>`
                                                + `<div style="font-size:12px; color:#0f172a; line-height:1.5;">${info.marketVolumeDisplay}</div>`
                                                + `<div style=\"font-size:12px; color:#047857; font-weight:500; border-top:1px solid #f1f5f9; padding-top:4px; margin-top:6px;\">🖱 双击进入省级地图</div>`;
                                        }
                                    }
                                    return params.name;
                                }
                            },
                            ...(marketType === 'frequency'
                                ? { visualMap: { show: false, type: 'piecewise', pieces: frequencyPieces } }
                                : marketType === 'overview'
                                    ? { visualMap: { show: true, left: '2%', bottom: '5%', type: 'piecewise', pieces: overviewPieces } }
                                    : {}),
                            series: [{
                                name: '市场分布',
                                type: 'map',
                                map: 'china',
                                roam: true,
                                zoom: 1.2,
                                center: [104.114129, 37.550339],
                                label: { show: true, fontSize: 10, color: 'rgba(0,0,0,0.5)' },
                                itemStyle: { areaColor: '#f8fafc', borderColor: '#cbd5e1', borderWidth: 1 },
                                emphasis: { label: { show: true, color: '#854d0e' }, itemStyle: { areaColor: currentPalette.highlight } },
                                data: generateMapData(),
                                selectedMode: false
                            }]
                        };
                    } else {
                        // === 省份视图 ===
                        const pPoints = (currentData.provincePoints || {})[provinceName] || [];
                        const pBelts = (currentData.provinceBelts || {})[provinceName] || [];
                        const provinceShortName = (provinceName || '').replace(/省|市|自治区|回族|壮族|维吾尔/g, '');
                        const isGansuProvince = provinceShortName === '甘肃';
                        const mergedPoints = isGansuProvince ? [...pPoints, ...(gansuUnifiedOverlay.points || [])] : pPoints;
                        const mergedBelts = isGansuProvince ? [...pBelts, ...(gansuUnifiedOverlay.belts || [])] : pBelts;
                        const mergedConnections = isGansuProvince ? (gansuUnifiedOverlay.connections || []) : [];

                        option = {
                            backgroundColor: 'transparent',
                            tooltip: {
                                trigger: 'item',
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                borderColor: '#e2e8f0', borderWidth: 1, padding: 12, textStyle: { color: '#1e293b' },
                                formatter: (params) => {
                                    if (params.data?.tooltipData) {
                                        const d = params.data.tooltipData;
                                        const typeInfo = pointTypeConfig[d.type] || { label: '未知' };
                                        return `<div style="font-weight:bold; margin-bottom:2px; color:${params.color}">${d.label}</div>`
                                                + `<div style=\"font-size:12px;color:#64748b; margin-bottom:4px;\">${d.desc || ''}</div>`
                                                + `<div style=\"font-size:10px;color:#94a3b8;\">类型: ${typeInfo.label}</div>`;
                                    }
                                    return params.name;
                                }
                            },
                            geo: {
                                map: mapName, roam: true, zoom: 1.0,
                                label: { show: true, color: '#64748b' },
                                itemStyle: { areaColor: '#e2e8f0', borderColor: '#94a3b8', borderWidth: 1.5, shadowColor: 'rgba(0, 0, 0, 0.2)', shadowBlur: 10 },
                                emphasis: { itemStyle: { areaColor: hoverHighlightColor }, label: { color: '#854d0e' } }
                            },
                            series: [
                                {
                                    name: '能源走廊区域', type: 'custom', coordinateSystem: 'geo',
                                    data: convertBeltPolygonData(mergedBelts),
                                    renderItem: (params, api) => {
                                        const belt = params.data;
                                        if (!belt?.coords?.length) return null;
                                        const points = belt.coords.map(coord => api.coord(coord));
                                        return {
                                            type: 'polygon',
                                            name: belt.name,
                                            shape: { points },
                                            style: {
                                                fill: belt.fillColor || 'rgba(14,165,233,0.16)',
                                                stroke: belt.strokeColor || '#38bdf8',
                                                lineWidth: 1.2,
                                                opacity: 0.9,
                                                shadowBlur: 14,
                                                shadowColor: belt.fillColor || 'rgba(56, 189, 248, 0.25)'
                                            },
                                            emphasis: {
                                                style: {
                                                    fill: belt.fillColor || 'rgba(14,165,233,0.28)',
                                                    opacity: 1,
                                                    shadowBlur: 18
                                                }
                                            }
                                        };
                                    },
                                    silent: false,
                                    zlevel: 1.5
                                },
                                {
                                    name: '网架联络', type: 'lines', coordinateSystem: 'geo',
                                    data: convertConnectionData(mergedConnections),
                                    lineStyle: { width: 2, color: '#0f172a', opacity: 0.9 },
                                    effect: { show: true, symbol: 'arrow', symbolSize: 8, period: 8, trailLength: 0 },
                                    zlevel: 1.8
                                },
                                {
                                    name: '能源基地', type: 'effectScatter', coordinateSystem: 'geo',
                                    data: convertPointData(mergedPoints),
                                    symbolSize: 18, showEffectOn: 'render', rippleEffect: { brushType: 'fill', scale: 2 },
                                    hoverAnimation: true, label: { show: false }, zlevel: 2
                                }
                            ]
                        };
                    }

                    chart.setOption(option);
                    setLoading(false);

                    chart.off('click');
                    chart.on('click', (params) => {
                        if (mode !== 'china') return;
                        if (params.componentType !== 'series' || params.seriesType !== 'map') return;
                        const clickedName = params.name;
                        const provinceInfo = currentData.details[clickedName];
                        const unifiedInfo = getUnifiedProvinceDetail(clickedName);

                        if (provinceInfo || unifiedInfo) {
                            setSelectedProvinceInfo({ ...(provinceInfo || {}), ...(unifiedInfo || {}) });
                            setSelectedProvinceName(clickedName);
                        } else {
                            setSelectedProvinceInfo(null);
                            setSelectedProvinceName(null);
                        }
                    });

                    chart.off('dblclick');
                    chart.on('dblclick', (params) => {
                        if (mode !== 'china') return;
                        if (params.componentType !== 'series' || params.seriesType !== 'map') return;
                        const clickedName = params.name;
                        if (adcodeMap[clickedName] && currentData.details[clickedName]) {
                            setCurrentProvince(clickedName);
                            const provinceInfo = currentData.details[clickedName];
                            const unifiedInfo = getUnifiedProvinceDetail(clickedName);
                            setSelectedProvinceInfo({ ...(provinceInfo || {}), ...(unifiedInfo || {}) });
                            setSelectedProvinceName(clickedName);
                            setViewMode('province');
                        }
                    });

                } catch (error) {
                    console.error('Map loading failed:', error);
                    setLoading(false);
                }
            };

            const handleResourceApply = () => {
                if (interactionMode !== 'edit') return;
                if (!resourceInput.trim()) return;
                const lines = resourceInput.split('\n').map(l => l.trim()).filter(Boolean);
                if (!lines.length) return;

                setResourceEndowment(prev => {
                    const next = { ...prev };
                    lines.forEach(line => {
                        const [province, metricKey, rawValue] = line.split(/[,，]/).map(v => v.trim());
                        const numValue = parseFloat(rawValue);
                        if (province && metricKey && !isNaN(numValue)) {
                            next[province] = { ...(next[province] || {}), [metricKey]: numValue };
                            setResourceLabels(old => old[metricKey] ? old : ({ ...old, [metricKey]: `${metricKey} (自定义)` }));
                        }
                    });
                    return next;
                });
                setResourceInput('');
            };

            const normalizeGridUploads = (rawUploads = {}) => {
                const normalized = {};
                Object.entries(rawUploads || {}).forEach(([province, value]) => {
                    if (Array.isArray(value)) {
                        normalized[province] = value;
                    } else if (value?.src) {
                        normalized[province] = [{ ...value, id: value.id || `${province}-${value.name || 'grid'}-${value.updatedAt || Date.now()}` }];
                    }
                });
                return normalized;
            };

            const gansuDefaultGridItem = {
                id: 'gansu-grid-default',
                src: gansuGridIllustration,
                name: '甘肃网架/负荷示意图（内置）',
                updatedAt: '内置示意'
            };

            const buildProvinceGridList = (provinceName) => {
                if (!provinceName) return [];
                const uploads = Array.isArray(gridUploads[provinceName]) ? gridUploads[provinceName] : [];
                const normalized = provinceName.replace(/省|市|自治区|回族|壮族|维吾尔/g, '');
                const list = [...uploads];
                if (normalized === '甘肃') {
                    list.unshift(gansuDefaultGridItem);
                }
                return list;
            };

            const handleProvinceGridUpload = (provinceName, files) => {
                if (interactionMode !== 'edit') return;
                if (!provinceName || !files?.length) return;
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const src = e.target.result;
                        setGridUploads(prev => {
                            const next = { ...prev };
                            const list = Array.isArray(next[provinceName]) ? [...next[provinceName]] : [];
                            list.push({
                                id: `${file.name}-${Date.now()}`,
                                src,
                                name: file.name,
                                updatedAt: new Date().toISOString()
                            });
                            next[provinceName] = list;
                            return next;
                        });
                        if (provinceName === gridUploadProvince) {
                            setGridPreview(src);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleGridUpload = (event) => {
                if (interactionMode !== 'edit') return;
                const files = Array.from(event.target.files || []);
                if (!files.length) return;
                if (!gridUploadProvince) {
                    alert('请先选择要归属的省份');
                    return;
                }
                handleProvinceGridUpload(gridUploadProvince, files);
                event.target.value = '';
            };

            const handleGridDelete = (province, id) => {
                if (interactionMode !== 'edit') return;
                setGridUploads(prev => {
                    const next = { ...prev };
                    const list = (next[province] || []).filter(item => item.id !== id);
                    if (list.length) {
                        next[province] = list;
                    } else {
                        delete next[province];
                    }

                    if (province === gridUploadProvince) {
                        setGridPreview(list[list.length - 1]?.src || null);
                    }

                    return next;
                });
            };

            const handleConfigExport = () => {
                if (interactionMode !== 'edit') return;
                const payload = {
                    resourceEndowment,
                    resourceLabels,
                    resourceMetric,
                    gridUploads
                };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'energy-map-config.json';
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleConfigImport = (event) => {
                if (interactionMode !== 'edit') return;
                const file = event.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.resourceEndowment) setResourceEndowment(json.resourceEndowment);
                        if (json.resourceLabels) setResourceLabels(prev => ({ ...prev, ...json.resourceLabels }));
                        if (json.resourceMetric) setResourceMetric(json.resourceMetric);
                        if (json.gridUploads) setGridUploads(normalizeGridUploads(json.gridUploads));

                        const importedProvince = json.gridUploads ? Object.keys(json.gridUploads)[0] : '';
                        if (importedProvince) {
                            setGridUploadProvince(importedProvince);
                            const importedList = normalizeGridUploads(json.gridUploads)[importedProvince] || [];
                            setGridPreview(importedList[importedList.length - 1]?.src || null);
                        }
                    } catch (error) {
                        console.error('导入失败', error);
                        alert('导入失败，请检查文件格式');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            useEffect(() => {
                if (!gridUploadProvince) {
                    const provinces = Object.keys(adcodeMap);
                    if (provinces.length) {
                        setGridUploadProvince(provinces[0]);
                    }
                }
            }, [gridUploadProvince]);

            useEffect(() => {
                if (!gridUploadProvince) {
                    setGridPreview(null);
                    return;
                }
                const provinceGrids = Array.isArray(gridUploads[gridUploadProvince]) ? gridUploads[gridUploadProvince] : [];
                setGridPreview(provinceGrids[provinceGrids.length - 1]?.src || null);
            }, [gridUploadProvince, gridUploads]);

            // 监听变化
            useEffect(() => {
                loadMap(viewMode, currentProvince);
            }, [viewMode, currentProvince, marketType, energyView, resourceData]);

            // 切换市场时重置视图
            useEffect(() => {
                setViewMode('china');
                setCurrentProvince(null);
                setSelectedProvinceInfo(null);
                setSelectedProvinceName(null);
                if (marketType !== 'energy') {
                    setEnergyView('price');
                }
            }, [marketType]);

            // 电能量内部视图切换时重置所选省份
            useEffect(() => {
                if (marketType === 'energy') {
                    setViewMode('china');
                    setCurrentProvince(null);
                    setSelectedProvinceInfo(null);
                    setSelectedProvinceName(null);
                }
            }, [energyView]);

            useEffect(() => {
                const handleResize = () => chartInstanceRef.current && chartInstanceRef.current.resize();
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                if (!pieContainerRef.current) return;

                const provinceName = selectedProvinceName || currentProvince;
                const fallbackMetrics = provinceName ? resourceEndowment[provinceName] : null;
                const fallbackPieData = fallbackMetrics
                    ? Object.entries(fallbackMetrics || {}).map(([k, v]) => ({
                        name: resourceLabels[k] || k,
                        value: Number(v) || 0,
                        key: k
                    })).sort((a, b) => b.value - a.value)
                    : null;

                const pieData = selectedProvinceInfo?.resourcePieData?.length
                    ? selectedProvinceInfo.resourcePieData
                    : fallbackPieData;

                if (!pieData?.length) {
                    if (pieInstanceRef.current) {
                        pieInstanceRef.current.dispose();
                        pieInstanceRef.current = null;
                    }
                    return;
                }

                if (!pieInstanceRef.current) {
                    pieInstanceRef.current = echarts.init(pieContainerRef.current);
                }

                pieInstanceRef.current.clear();
                pieInstanceRef.current.setOption({
                    tooltip: { trigger: 'item' },
                    legend: { show: false },
                    series: [{
                        name: '资源占比',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
                        label: { formatter: '{b}: {d}%', color: '#0f172a' },
                        data: pieData
                    }]
                });

                pieInstanceRef.current.resize();
            }, [selectedProvinceInfo, selectedProvinceName, currentProvince, resourceEndowment, resourceLabels]);

            useEffect(() => {
                const handlePieResize = () => {
                    if (pieInstanceRef.current) {
                        pieInstanceRef.current.resize();
                    }
                };
                window.addEventListener('resize', handlePieResize);
                return () => window.removeEventListener('resize', handlePieResize);
            }, []);

            const getUnifiedProvinceDetail = (provinceName) => {
                if (!provinceName) return null;
                const frequencyInfo = frequencyData.details?.[provinceName];
                const energyInfo = energyData.details?.[provinceName];
                const spotInfo = spotProgressData.details?.[provinceName];
                const resourceInfo = resourceData.details?.[provinceName];

                const combinedDetails = [];
                if (frequencyInfo) combinedDetails.push({ label: '二次调频', value: frequencyInfo.marketVolumeDisplay || frequencyInfo.totalVolume });
                if (energyInfo) combinedDetails.push({ label: '电能量', value: energyInfo.marketVolumeDisplay || energyInfo.totalVolume });
                if (spotInfo) combinedDetails.push({ label: '现货/政策', value: spotInfo.marketVolumeDisplay || '现货市场进展' });
                if (resourceInfo) {
                    combinedDetails.push({ label: '资源禀赋', value: resourceInfo.marketVolumeDisplay || resourceInfo.totalVolume });
                }

                const detailList = [...combinedDetails, ...(resourceInfo?.details || [])];

                return {
                    title: `${provinceName} 综合信息`,
                    totalVolume: frequencyInfo?.totalVolume || energyInfo?.totalVolume || resourceInfo?.totalVolume || '综合侧栏',
                    marketVolumeDisplay: '从任意视图进入省级视图时统一展示综合数据',
                    tags: ['综合信息', '统一省级侧栏'],
                    details: detailList,
                    resourcePieData: resourceInfo?.resourcePieData
                };
            };

            const handleBack = () => {
                setViewMode('china');
                setCurrentProvince(null);
                setSelectedProvinceInfo(null);
                setSelectedProvinceName(null);
            };

            const energyViewTitle = energyView === 'price'
                ? '电能量市场热力图'
                : '现货市场进程热力图（含政策信息）';

            const detailSummaryTitle = marketType === 'frequency'
                ? '调频收益概览'
                : marketType === 'resource'
                    ? '资源禀赋概览'
                    : marketType === 'overview'
                        ? '总体视图概览'
                        : energyView === 'price'
                            ? '电能量市场概览'
                            : '现货市场进程概览';

            const detailProvinceName = selectedProvinceName || currentProvince;
            const provinceGridList = buildProvinceGridList(detailProvinceName);

            const mainTitle = viewMode === 'province'
                ? `${currentProvince}详情`
                : (marketType === 'overview'
                    ? '全国总体视图（调频 vs 电能量）'
                    : marketType === 'frequency'
                        ? '二次调频市场热力图'
                        : marketType === 'resource'
                            ? '资源禀赋热力图'
                            : energyViewTitle);

            const normalizedProvinceLabel = (detailProvinceName || '').replace(/省|市|自治区|回族|壮族|维吾尔/g, '');
            const shouldShowGansuSidebar = normalizedProvinceLabel === '甘肃'
                || selectedProvinceInfo?.name === '甘肃'
                || selectedProvinceInfo?.provinceCode === 'GS';
            const appMode = interactionMode === 'edit' ? 'EDIT' : 'VIEW';

            const handleSidebarClose = () => {
                setSelectedProvinceInfo(null);
                setSelectedProvinceName(null);
            };

            const startSidebarResize = (event) => {
                if (!isSidebarOpen) return;
                sidebarResizeDataRef.current = { startX: event.clientX, startWidth: sidebarWidth };
                setIsResizingSidebar(true);
            };

            useEffect(() => {
                if (!isResizingSidebar) return;

                const handleMouseMove = (event) => {
                    const delta = event.clientX - sidebarResizeDataRef.current.startX;
                    const nextWidth = Math.min(Math.max(sidebarResizeDataRef.current.startWidth + delta, 240), 480);
                    setSidebarWidth(nextWidth);
                };

                const handleMouseUp = () => setIsResizingSidebar(false);

                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);

                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isResizingSidebar]);

            return (
                <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden relative">
                    {interactionMode === 'edit' && (
                        <div className="fixed left-3 bottom-3 z-50 flex flex-col gap-2">
                            <button
                                onClick={() => setShowArchivePanel(true)}
                                className="w-11 h-11 rounded-xl bg-slate-900 text-white shadow-lg border border-slate-800 flex items-center justify-center hover:bg-slate-800 transition-all"
                                title="导入/导出热力图存档"
                            >
                                <ArchiveIcon size={18} />
                            </button>
                            <span className="text-[10px] text-slate-500 text-center leading-tight">存档</span>
                        </div>
                    )}

                    {showArchivePanel && (
                        <div className="fixed inset-0 z-50 flex items-end justify-start bg-black/20" onClick={() => setShowArchivePanel(false)}>
                            <div
                                className="pointer-events-auto bg-white border border-slate-200 rounded-2xl shadow-2xl m-4 p-4 w-80 space-y-3"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2 text-slate-800 font-semibold text-sm"><ArchiveIcon size={16} />热力图存档</div>
                                    <button onClick={() => setShowArchivePanel(false)} className="text-slate-400 hover:text-slate-600"><X size={16} /></button>
                                </div>
                                <p className="text-[11px] text-slate-600 leading-relaxed">上传的网架图和资源录入会被一并保存，导出后可直接发给同事或下次导入继续编辑。</p>
                                <div className="flex gap-2">
                                    <button
                                        onClick={handleConfigExport}
                                        className="flex-1 bg-slate-900 hover:bg-slate-800 text-white text-[12px] font-bold py-2 rounded-md shadow-sm"
                                    >
                                        导出配置
                                    </button>
                                    <label className="flex-1 bg-white border border-slate-200 text-slate-700 text-[12px] font-bold py-2 rounded-md shadow-sm cursor-pointer hover:border-slate-300 hover:bg-slate-50 text-center">
                                        导入配置
                                        <input type="file" accept="application/json" onChange={handleConfigImport} className="hidden" />
                                    </label>
                                </div>
                                <div className="text-[10px] text-slate-400">生成 energy-map-config.json 作为热力图档案，随时恢复当前修改。</div>
                            </div>
                        </div>
                    )}

                    <header className="bg-white shadow-sm border-b border-slate-200 px-6 py-4 flex items-center justify-between z-10 shrink-0 relative">
                        <div className="flex items-center space-x-3">
                            {viewMode === 'province' ? (
                                <button onClick={handleBack} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium">
                                    <ArrowLeft size={16} /> 返回全国
                                </button>
                            ) : (
                                <div className={`bg-gradient-to-br ${currentPalette.gradientFrom} ${currentPalette.gradientTo} p-2.5 rounded-xl text-white shadow-md transition-all duration-500`}>
                                    <Activity size={24} />
                                </div>
                            )}
                            
                            <div>
                                <h1 className="text-xl font-bold text-slate-900 tracking-tight">{mainTitle}</h1>
                                <div className="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                    <span className={`px-1.5 py-0.5 rounded border flex items-center gap-1 ${currentPalette.iconBg} ${currentPalette.iconText} ${currentPalette.iconBorder}`}>
                                        {viewMode === 'province' ? <MapIcon size={12} /> : <Zap size={12} fill="currentColor" />}
                                        <span>{viewMode === 'province' ? '省内微观视角' : '全国宏观视角'}</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-3 text-sm">
                            <div className="flex items-center gap-2 bg-slate-100 rounded-lg p-1 border border-slate-200">
                                <button
                                    onClick={() => setInteractionMode('view')}
                                    className={`px-3 py-1 rounded-md text-xs font-bold ${interactionMode === 'view' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    查看模式
                                </button>
                                <button
                                    onClick={() => setInteractionMode('edit')}
                                    className={`px-3 py-1 rounded-md text-xs font-bold ${interactionMode === 'edit' ? 'bg-slate-900 text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    编辑模式
                                </button>
                            </div>
                            <span className="text-[11px] text-slate-500">{interactionMode === 'edit' ? '可导入图片并编辑全部字段' : '仅浏览与切换视图，禁用编辑入口'}</span>
                        </div>
                    </header>

                    <div className="flex-1 relative w-full h-full overflow-hidden">
                        <div className="w-full h-full bg-slate-50 flex">
                            
                            {/* --- 左侧伸缩面板 --- */}
                            <div
                                className="absolute left-0 top-0 bottom-0 z-40 bg-white/95 backdrop-blur shadow-xl border-r border-slate-200 transition-all duration-300 ease-in-out flex flex-col overflow-hidden"
                                style={{ width: isSidebarOpen ? `${sidebarWidth}px` : 0, transform: isSidebarOpen ? 'translateX(0)' : 'translateX(-100%)' }}
                            >
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                                    <div className="flex items-center gap-2 text-slate-700 font-bold">
                                        <Layers size={18} />
                                        <span>市场视图切换</span>
                                    </div>
                                </div>
                                
                                <div className="p-4 overflow-y-auto flex-1 space-y-6">
                                    
                                    {/* 0. 市场类型切换器 (核心功能) */}
                                    <div className="p-1 bg-slate-100 rounded-lg flex gap-1">
                                        <button
                                            onClick={() => setMarketType('overview')}
                                            className={`flex-1 py-2 px-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 ${marketType === 'overview' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <MapIcon size={14} /> 总体视图
                                        </button>
                                        <button
                                            onClick={() => setMarketType('frequency')}
                                            className={`flex-1 py-2 px-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 ${marketType === 'frequency' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <Activity size={14} /> 二次调频
                                        </button>
                                        <button
                                            onClick={() => setMarketType('energy')}
                                            className={`flex-1 py-2 px-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 ${marketType === 'energy' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <BatteryCharging size={14} /> 电能量
                                        </button>
                                        <button
                                            onClick={() => setMarketType('resource')}
                                            className={`flex-1 py-2 px-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 ${marketType === 'resource' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                        >
                                            <Layers size={14} /> 资源禀赋
                                        </button>
                                    </div>

                                    {/* 电能量视图切换器 */}
                                    {marketType === 'energy' && (
                                        <div className="space-y-2 bg-indigo-50/60 border border-indigo-100 rounded-lg p-3">
                                            <div className="text-[11px] text-indigo-700 font-semibold flex items-center gap-2">
                                                <Layers size={12} /> 电能量视图选择
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <button
                                                    onClick={() => setEnergyView('price')}
                                                    className={`px-2 py-1.5 rounded-md text-[11px] font-bold border transition-all ${energyView === 'price' ? 'bg-white text-indigo-700 border-indigo-200 shadow-sm' : 'text-slate-600 border-slate-200 hover:border-indigo-200 hover:text-indigo-700 bg-white/70'}`}
                                                >
                                                    价差地图
                                                </button>
                                                <button
                                                    onClick={() => setEnergyView('spot-progress')}
                                                    className={`px-2 py-1.5 rounded-md text-[11px] font-bold border transition-all ${energyView === 'spot-progress' ? 'bg-white text-indigo-700 border-indigo-200 shadow-sm' : 'text-slate-600 border-slate-200 hover:border-indigo-200 hover:text-indigo-700 bg-white/70'}`}
                                                >
                                                    现货市场进程
                                                </button>
                                            </div>
                                            <div className="text-[11px] text-slate-600 leading-relaxed">
                                                在价差与现货进程（含政策信息）两张热力图间切换，颜色均按程度由浅到深递进显示。
                                            </div>
                                        </div>
                                    )}

                                    {marketType === 'resource' && (
                                        <div className="space-y-3 bg-emerald-50/70 border border-emerald-100 rounded-lg p-3">
                                            <div className="text-[11px] text-emerald-800 font-semibold flex items-center gap-2">
                                                <Layers size={12} /> 资源禀赋视图选择
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-[11px] text-slate-600">选择要绘制的装机口径</label>
                                                <select
                                                    value={resourceMetric}
                                                    onChange={(e) => setResourceMetric(e.target.value)}
                                                    className="w-full rounded-md border border-emerald-200 bg-white px-2 py-1 text-sm text-emerald-900 focus:outline-none focus:ring-2 focus:ring-emerald-300"
                                                >
                                                    {resourceMetrics.map(key => (
                                                        <option key={key} value={key}>{resourceLabels[key] || key}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            {interactionMode === 'edit' ? (
                                                <>
                                                    <div className="text-[11px] text-slate-600 leading-relaxed bg-white/60 border border-emerald-100 rounded-md p-2">
                                                        任意指标都可成为热力图底层数据。输入“省份,指标,数值”可追加装机信息，支持多行批量导入。
                                                    </div>
                                                    <textarea
                                                        value={resourceInput}
                                                        onChange={(e) => setResourceInput(e.target.value)}
                                                        placeholder="示例: 河北省,风电,36.5\n甘肃省,光伏,42"
                                                        className="w-full h-20 text-sm rounded-md border border-emerald-200 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-300"
                                                    ></textarea>
                                                    <button
                                                        onClick={handleResourceApply}
                                                        className="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold py-2 rounded-md shadow-sm"
                                                    >
                                                        应用资源录入
                                                    </button>
                                                    <div className="space-y-2 pt-1">
                                                        <div className="flex items-center justify-between gap-2">
                                                            <label className="text-[11px] text-slate-600">上传网架/规划示意图 (图片)</label>
                                                            <select
                                                                value={gridUploadProvince}
                                                                onChange={(e) => setGridUploadProvince(e.target.value)}
                                                                className="rounded-md border border-emerald-200 bg-white px-2 py-1 text-[11px] text-emerald-900 focus:outline-none focus:ring-2 focus:ring-emerald-300"
                                                            >
                                                                {Object.keys(adcodeMap).map(name => (
                                                                    <option key={name} value={name}>{name}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                        <input type="file" multiple accept="image/*" onChange={handleGridUpload} className="text-[11px]" />
                                                        {gridPreview && (
                                                            <div className="border border-emerald-100 rounded-lg overflow-hidden bg-white shadow-sm">
                                                                <img src={gridPreview} alt="网架预览" className="w-full h-24 object-cover" />
                                                                <div className="text-[10px] text-slate-500 px-2 py-1">{gridUploadProvince || '未选择省份'} 已加载网架图，详情栏将自动展示</div>
                                                            </div>
                                                        )}
                                                        {Object.keys(gridUploads).length > 0 && (
                                                            <div className="text-[11px] text-emerald-700 bg-emerald-50 border border-emerald-100 rounded-md px-2 py-1">
                                                                已为 {Object.keys(gridUploads).join('、')} 保存 {Object.values(gridUploads).reduce((sum, list) => sum + (Array.isArray(list) ? list.length : 0), 0)} 张网架图
                                                            </div>
                                                        )}
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-[11px] text-emerald-700 bg-white border border-emerald-100 rounded-md p-2">
                                                    当前为查看模式，仅保留装机口径切换，编辑录入与图片上传已隐藏。
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* 1. 收益/热度图例 */}
                                    {viewMode === 'china' && (
                                        <div className="space-y-3 animate-in fade-in slide-in-from-left-4 duration-500">
                                            <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                {marketType === 'frequency' ? '调频收益 (热度)' : (energyView === 'price' ? '电能量价差热力图' : energyView === 'spot-progress' ? '现货市场进程热力图' : '电能量政策热力图')}
                                            </div>
                                            {marketType === 'frequency' ? (
                                                <div className="flex items-center gap-3">
                                                    <div className="h-32 w-2 rounded-full shadow-inner bg-gradient-to-b from-[#001A72] via-[#0057F1] to-[#66D4FF]"></div>
                                                    <div className="flex flex-col justify-between h-32 text-xs text-slate-600 font-medium">
                                                        <span>高</span>
                                                        <span>中高</span>
                                                        <span>中</span>
                                                        <span>中低</span>
                                                        <span>低</span>
                                                    </div>
                                                </div>
                                            ) : marketType === 'resource' ? (
                                                <div className="space-y-2">
                                                    <div className="flex items-center gap-3">
                                                        <div className="h-24 w-3 rounded-full shadow-inner bg-gradient-to-b from-emerald-900 via-emerald-500 to-emerald-100"></div>
                                                        <div className="flex flex-col justify-between h-24 text-[11px] text-slate-600 font-medium">
                                                            <span>{formatPriceLabel(resourceRange.max)} GW</span>
                                                            <span>{formatPriceLabel(resourceRange.min)} GW</span>
                                                        </div>
                                                        <span className="text-[11px] text-emerald-800 font-semibold px-2 py-1 bg-emerald-50 border border-emerald-100 rounded">装机规模</span>
                                                    </div>
                                                    <div className="text-[11px] leading-relaxed text-slate-600 bg-slate-50 border border-emerald-100 rounded-lg p-2">
                                                        绿色越深表示装机规模越大，可自由切换口径、支持自定义录入和网架图叠加。
                                                    </div>
                                                </div>
                                            ) : energyView === 'price' ? (
                                                <div className="space-y-4">
                                                    <div className="flex items-center gap-3">
                                                        <div
                                                            className="h-24 w-3 rounded-full shadow-inner"
                                                            style={{
                                                                background: 'linear-gradient(to bottom, #001A72 0%, #0038B8 28%, #0057F1 52%, #1FAEFF 76%, #66D4FF 100%)'
                                                            }}
                                                        ></div>
                                                        <div className="flex flex-col justify-between h-24 text-[11px] text-slate-600 font-medium">
                                                            {actualScaleLabels.map((label, idx) => (
                                                                <span key={`actual-scale-${idx}`}>{formatPriceLabel(label)}</span>
                                                            ))}
                                                        </div>
                                                        <span className="text-[11px] text-blue-700 font-semibold px-2 py-1 bg-blue-50 border border-blue-100 rounded">实测省份</span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <div
                                                            className="h-24 w-3 rounded-full shadow-inner"
                                                            style={{
                                                                background: 'linear-gradient(to bottom, #1f2937 0%, #475569 35%, #94a3b8 65%, #cbd5e1 85%, #f8fafc 100%)'
                                                            }}
                                                        ></div>
                                                        <div className="flex flex-col justify-between h-24 text-[11px] text-slate-600 font-medium">
                                                            {marketScaleLabels.map((label, idx) => (
                                                                <span key={`market-scale-${idx}`}>{formatPriceLabel(label)}</span>
                                                            ))}
                                                        </div>
                                                        <span className="text-[11px] text-slate-700 font-semibold px-2 py-1 bg-slate-50 border border-slate-200 rounded">市场区间省份</span>
                                                    </div>
                                                    <div className="text-[11px] leading-relaxed text-slate-600 bg-slate-50 border border-slate-100 rounded-lg p-2">
                                                        图例显示滑块两端的约值（无单位），点击省份查看区间或备注。
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="space-y-3 text-[11px] text-slate-700">
                                                    <div className="space-y-2">
                                                        <div className="flex items-center gap-3">
                                                            <div
                                                            className="h-24 w-3 rounded-full shadow-inner"
                                                            style={{
                                                                    background: 'linear-gradient(to bottom, #001A72 0%, #0038B8 24%, #0057F1 48%, #1FAEFF 72%, #66D4FF 90%, #A8ECFF 100%)'
                                                                }}
                                                            ></div>
                                                            <div className="flex flex-col justify-between h-24 text-[11px] text-slate-700 font-semibold">
                                                                <span>成熟度高</span>
                                                                <span>暂无现货进展</span>
                                                            </div>
                                                            <span className="text-[11px] text-indigo-800 font-semibold px-2 py-1 bg-blue-50 border border-blue-100 rounded">已调研储能省份</span>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                        <div
                                                                className="h-24 w-3 rounded-full shadow-inner"
                                                                style={{
                                                                    background: 'linear-gradient(to bottom, #1f2937 0%, #475569 30%, #94a3b8 60%, #cbd5e1 82%, #e2e8f0 92%, #f8fafc 100%)'
                                                                }}
                                                            ></div>
                                                            <div className="flex flex-col justify-between h-24 text-[11px] text-slate-700 font-semibold">
                                                                <span>成熟度高</span>
                                                                <span>暂无现货进展</span>
                                                            </div>
                                                            <span className="text-[11px] text-slate-800 font-semibold px-2 py-1 bg-slate-50 border border-slate-200 rounded">未调研 / 暂未开放</span>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-1 gap-1.5">
                                                        {[5,4,3,2,1,0].map((level) => (
                                                            <span
                                                                key={`progress-${level}`}
                                                                className="px-2 py-1 rounded-full bg-slate-50 border border-slate-100 text-slate-700 text-[11px]"
                                                            >
                                                                {spotProgressLevelText[level] || spotProgressLevelText[0]}
                                                            </span>
                                                        ))}
                                                    </div>
                                                    <div className="text-[11px] leading-relaxed text-slate-600 bg-slate-50 border border-slate-100 rounded-lg p-2">
                                                        蓝色系表示已调研、储能已参与或即将参与现货的省份，灰色系表示未调研或暂未对储能开放；颜色越深代表成熟度越高，点击或悬停可查看进展说明与政策信息。
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="border-t border-slate-100"></div>

                                    {/* 2. 能源基地类型图例 */}
                                    <div className="space-y-3">
                                        <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">能源基地图例</div>
                                        <div className="space-y-2 text-xs text-slate-700">
                                            {Object.entries(pointTypeConfig).map(([key, cfg]) => (
                                                <div key={key} className="flex items-center gap-2 p-2 rounded hover:bg-slate-50 transition-colors">
                                                    {cfg.symbol === 'circle' && <div className="w-3 h-3 rounded-full border border-white shadow-sm flex-shrink-0" style={{backgroundColor: cfg.color}}></div>}
                                                    {cfg.symbol === 'rect' && <div className="w-3 h-3 border border-white shadow-sm flex-shrink-0" style={{backgroundColor: cfg.color}}></div>}
                                                    {cfg.symbol === 'triangle' && <div className="w-3 h-3 border border-white shadow-sm flex-shrink-0" style={{backgroundColor: cfg.color, clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)'}}></div>}
                                                    {cfg.symbol === 'diamond' && <div className="w-3 h-3 border border-white shadow-sm flex-shrink-0 rotate-45" style={{backgroundColor: cfg.color}}></div>}
                                                    <span>{cfg.label}</span>
                                                </div>
                                            ))}
                                            <div className="flex items-center gap-2 p-2 rounded hover:bg-slate-50 transition-colors">
                                                <div className="w-8 h-3 bg-slate-300 rounded border border-white shadow-sm flex items-center justify-center relative flex-shrink-0">
                                                    <div className="w-6 h-1 bg-slate-400/50 rounded-full"></div>
                                                </div>
                                                <span className="text-slate-500">走廊/产业带</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 3. 梯队信息 (仅调频显示) */}
                                    {marketType === 'frequency' && viewMode === 'china' && (
                                        <>
                                            <div className="border-t border-slate-100"></div>
                                            <div className="space-y-3">
                                                <div className="text-xs font-bold text-slate-500 uppercase tracking-wider">潜在市场 (梯队)</div>
                                                <div className="space-y-2 text-xs text-slate-700">
                                                    <div className="flex items-center gap-2"><div className="w-2.5 h-2.5 rounded bg-[#52525b]"></div><span>第一梯队</span></div>
                                                    <div className="flex items-center gap-2"><div className="w-2.5 h-2.5 rounded bg-[#9ca3af]"></div><span>第二梯队</span></div>
                                                    <div className="flex items-center gap-2"><div className="w-2.5 h-2.5 rounded bg-[#e5e7eb]"></div><span>第三梯队</span></div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                    
                                    <div className="pt-4 text-center">
                                        <div className="text-[10px] text-slate-300 border border-dashed border-slate-200 rounded p-2 hover:border-slate-300 hover:text-slate-400 cursor-pointer transition-colors">
                                            + 添加更多筛选器 (预留)
                                        </div>
                                    </div>
                                    </div>
                                {isSidebarOpen && (
                                    <div
                                        className={`absolute top-0 right-0 h-full w-1.5 cursor-col-resize bg-transparent transition-colors ${isResizingSidebar ? 'bg-slate-200/80' : 'hover:bg-slate-200/70'}`}
                                        onMouseDown={startSidebarResize}
                                        title="拖拽以调整侧边栏宽度"
                                    ></div>
                                )}
                            </div>

                            <button
                                onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                className="absolute top-4 z-30 bg-white p-2 rounded-r-lg shadow-md border border-l-0 border-slate-200 text-slate-500 hover:text-slate-800 hover:bg-slate-50 transition-all duration-300"
                                style={{ left: isSidebarOpen ? sidebarWidth : 0 }}
                            >
                                {isSidebarOpen ? <ChevronLeft size={16} /> : <ChevronRight size={16} />}
                            </button>

                            <div className="flex-1 relative">
                                {loading && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 gap-3 bg-slate-50 z-50">
                                        <div className="w-8 h-8 border-4 border-current border-t-transparent rounded-full animate-spin text-blue-500"></div>
                                        <span className="text-sm">正在重绘地图...</span>
                                    </div>
                                )}
                                <div ref={mapContainerRef} className="w-full h-full cursor-pointer" />
                            </div>
                        </div>

                        {/* 右侧详情面板 */}
                        <div className={`absolute right-0 top-0 bottom-0 z-30 w-full md:w-[480px] bg-white shadow-2xl md:border-l border-slate-200 transform transition-transform duration-300 ease-in-out flex flex-col ${selectedProvinceInfo ? 'translate-x-0' : 'translate-x-full'}`}>
                            {selectedProvinceInfo && (
                                shouldShowGansuSidebar ? (
                                    <GansuProvinceSidebarText
                                        mode={appMode}
                                        onClose={handleSidebarClose}
                                        gridList={buildProvinceGridList('甘肃省')}
                                        onUploadGrid={(files) => handleProvinceGridUpload('甘肃省', files)}
                                    />
                                ) : (
                                    <>
                                        <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-gradient-to-br from-slate-50 to-white">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1"><h2 className="text-2xl font-bold text-slate-800">{selectedProvinceInfo.title}</h2></div>
                                                <div className="flex flex-wrap gap-2 mt-2">
                                                    {selectedProvinceInfo.totalVolume && <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-bold border shadow-sm ${marketType === 'frequency' ? 'bg-blue-100 text-blue-700 border-blue-200' : marketType === 'resource' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200'}`}>总量: {selectedProvinceInfo.totalVolume}</span>}
                                                    {selectedProvinceInfo.tags && selectedProvinceInfo.tags.map((tag, i) => <span key={i} className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">{tag}</span>)}
                                                </div>
                                            </div>
                                            <button
                                                onClick={handleSidebarClose}
                                                className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-all"
                                            ><X size={24} /></button>
                                        </div>
                                        <div className="p-6 overflow-y-auto space-y-6 flex-1 bg-white">
                                            {/* 动态卡片颜色 */}
                                            <div className={`rounded-xl p-5 border shadow-sm relative overflow-hidden ${marketType === 'frequency' ? 'bg-white border-blue-100 shadow-blue-50/50' : marketType === 'resource' ? 'bg-white border-emerald-100 shadow-emerald-50/50' : 'bg-white border-indigo-100 shadow-indigo-50/50'}`}>
                                                {selectedProvinceInfo.heatValue > 0 && <div className={`absolute top-0 right-0 w-16 h-16 bg-gradient-to-bl -mr-4 -mt-4 rounded-full opacity-50 ${marketType === 'frequency' ? 'from-blue-50' : marketType === 'resource' ? 'from-emerald-50' : 'from-indigo-50'}`}></div>}
                                                <div className={`flex items-center gap-2 font-semibold mb-3 ${marketType === 'frequency' ? 'text-blue-700' : marketType === 'resource' ? 'text-emerald-700' : 'text-indigo-600'}`}>
                                                    {marketType === 'frequency' ? <Coins size={20} /> : marketType === 'resource' ? <Layers size={20} /> : <Zap size={20} />}
                                                    <span>{detailSummaryTitle}</span>
                                                </div>
                                                <p className="text-lg text-slate-800 font-medium leading-relaxed">{selectedProvinceInfo.marketVolumeDisplay}</p>
                                            </div>

                                            {selectedProvinceInfo.resourcePieData && (
                                                <div className="space-y-2">
                                                    <div className="flex items-center gap-2 text-xs font-bold text-emerald-700 uppercase tracking-wider"><MapIcon size={14} />资源结构</div>
                                                    <div ref={pieContainerRef} className="w-full h-56" />
                                                </div>
                                            )}

                                            {detailProvinceName && provinceGridList.length > 0 && (
                                                <div className="space-y-3">
                                                    <div className="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wider"><Layers size={14} />网架/规划示意图</div>
                                                    <div className="grid gap-3 sm:grid-cols-2">
                                                        {provinceGridList.map(item => (
                                                            <div key={item.id} className="bg-slate-50 rounded-xl border border-slate-100 overflow-hidden shadow-sm">
                                                                <div className="relative">
                                                                    <img
                                                                        src={item.src}
                                                                        alt={`${detailProvinceName} 网架示意图`}
                                                                        className="w-full h-48 object-cover cursor-pointer"
                                                                        onClick={() => setPreviewImage({ src: item.src, alt: item.name || `${detailProvinceName} 网架示意图` })}
                                                                    />
                                                                    {interactionMode === 'edit' && (
                                                                        <button
                                                                            onClick={() => handleGridDelete(detailProvinceName, item.id)}
                                                                            className="absolute top-2 right-2 bg-white/90 text-slate-600 hover:text-red-600 border border-slate-200 rounded-full p-1 shadow-sm"
                                                                            title="删除此网架图"
                                                                        >
                                                                            <X size={14} />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                                <div className="text-[11px] text-slate-500 px-3 py-2 flex items-center justify-between">
                                                                    <span className="truncate" title={item.name || '自定义上传'}>{item.name || '自定义上传'}</span>
                                                                    {item.updatedAt && (
                                                                        <span className="text-[10px] text-slate-400">更新时间: {new Date(item.updatedAt).toLocaleString('zh-CN', { hour12: false })}</span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {selectedProvinceInfo.details && (
                                                <div className="space-y-4">
                                                    <div className="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-wider"><BarChart3 size={14} />详细数据 / 调研情况</div>
                                                    <div className="bg-slate-50 rounded-xl border border-slate-100 divide-y divide-slate-100">
                                                        {selectedProvinceInfo.details.map((item, idx) => (
                                                            <div key={idx} className="p-4 flex flex-col gap-1.5 hover:bg-slate-50/80 transition-colors">
                                                                <span className="text-xs text-slate-500 font-medium flex items-center gap-1"><span className="w-1 h-1 rounded-full bg-slate-400"></span>{item.label}</span>
                                                                <span className="text-slate-900 text-sm leading-relaxed pl-2 border-l-2 border-slate-200">{item.value}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )
                            )}
                        </div>
                    </div>
                    {previewImage && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-6" onClick={() => setPreviewImage(null)}>
                            <div className="bg-white rounded-xl shadow-2xl overflow-hidden max-w-4xl w-full" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center justify-between px-4 py-2 border-b border-slate-100">
                                    <span className="text-sm font-semibold text-slate-700">{previewImage.alt || '图片预览'}</span>
                                    <button onClick={() => setPreviewImage(null)} className="text-slate-400 hover:text-slate-700"><X size={16} /></button>
                                </div>
                                <div className="max-h-[80vh] overflow-auto bg-slate-50">
                                    <img src={previewImage.src} alt={previewImage.alt || '图片预览'} className="w-full h-full object-contain" />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EnergyMarketMap />);
    </script>
</body>

</html>



